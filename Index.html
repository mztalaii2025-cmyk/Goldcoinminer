<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>معدن‌چی طلا - VIP</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --gold: #FFD700;
            --gold-dark: #D4AF37;
            --gold-light: #FFEC8B;
            --black: #0A0A0A;
            --dark: #1A1A1A;
            --darker: #121212;
            --light: #F5F5F5;
            --gray: #8C8C8C;
            --success: #00C851;
            --warning: #FFD700;
            --danger: #FF4444;
            --usdt-color: #26a17b;
            --vip-gold: #FFD700;
            --vip-diamond: #4EE2EC;
            --vip-purple: #9D4EDD;
            --glass: rgba(255, 215, 0, 0.1);
            --glass-border: rgba(255, 215, 0, 0.3);
            --admin-color: #FF6B6B;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Vazirmatn', sans-serif;
            font-weight: 700;
        }
        
        body {
            background: linear-gradient(135deg, var(--black) 0%, var(--darker) 100%);
            color: var(--light);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ==================== سیستم نوتیفیکیشن ==================== */
        .notification-container {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 99999;
            display: flex;
            flex-direction: column;
            align-items: center;
            pointer-events: none;
        }
        
        .notification {
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 12px;
            max-width: 400px;
            width: 100%;
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.4),
                0 0 0 2px var(--gold);
            border: 1px solid rgba(255, 215, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 15px;
            transform: translateY(-20px);
            opacity: 0;
            animation: notificationSlideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            pointer-events: auto;
            position: relative;
            overflow: hidden;
        }
        
        .notification::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--gold), var(--gold-dark));
        }
        
        .notification.success::before {
            background: linear-gradient(90deg, var(--success), #00a844);
        }
        
        .notification.error::before {
            background: linear-gradient(90deg, var(--danger), #ff2222);
        }
        
        .notification.warning::before {
            background: linear-gradient(90deg, var(--warning), #ffaa00);
        }
        
        .notification.info::before {
            background: linear-gradient(90deg, var(--gold), var(--gold-dark));
        }
        
        .notification-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            background: rgba(255, 215, 0, 0.15);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .notification.success .notification-icon {
            background: rgba(0, 200, 81, 0.15);
            color: var(--success);
        }
        
        .notification.error .notification-icon {
            background: rgba(255, 68, 68, 0.15);
            color: var(--danger);
        }
        
        .notification.warning .notification-icon {
            background: rgba(255, 215, 0, 0.15);
            color: var(--warning);
        }
        
        .notification.info .notification-icon {
            background: rgba(255, 215, 0, 0.15);
            color: var(--gold);
        }
        
        .notification-content {
            flex: 1;
            min-width: 0;
        }
        
        .notification-title {
            font-size: 1rem;
            color: var(--light);
            margin-bottom: 4px;
            font-weight: 800;
        }
        
        .notification-message {
            font-size: 0.85rem;
            color: var(--gray);
            line-height: 1.4;
        }
        
        .notification-close {
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            font-size: 1rem;
            padding: 5px;
            border-radius: 6px;
            transition: all 0.3s;
            flex-shrink: 0;
        }
        
        .notification-close:hover {
            color: var(--light);
            background: rgba(255, 255, 255, 0.1);
        }
        
        .notification-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: rgba(255, 215, 0, 0.2);
            overflow: hidden;
        }
        
        .notification-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--gold), var(--gold-dark));
            width: 100%;
            transform-origin: left;
        }
        
        @keyframes notificationSlideIn {
            0% {
                transform: translateY(-20px);
                opacity: 0;
            }
            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes notificationSlideOut {
            0% {
                transform: translateY(0);
                opacity: 1;
            }
            100% {
                transform: translateY(-20px);
                opacity: 0;
            }
        }
        
        @keyframes progressShrink {
            0% {
                transform: scaleX(1);
            }
            100% {
                transform: scaleX(0);
            }
        }

        /* ==================== لودینگ صفحه ==================== */
        #loadingPage {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--black) 0%, var(--darker) 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
        }

        .loading-container {
            text-align: center;
            padding: 40px;
            background: rgba(26, 26, 26, 0.9);
            border-radius: 25px;
            border: 2px solid var(--gold);
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.3);
            max-width: 400px;
            width: 90%;
        }

        .loading-logo {
            font-size: 4rem;
            color: var(--gold);
            margin-bottom: 20px;
            animation: goldPulse 2s infinite;
        }

        @keyframes goldPulse {
            0%, 100% { 
                transform: scale(1);
                text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            }
            50% { 
                transform: scale(1.1);
                text-shadow: 0 0 30px rgba(255, 215, 0, 1);
            }
        }

        .loading-title {
            font-size: 2.5rem;
            color: var(--gold);
            margin-bottom: 10px;
            font-weight: 800;
        }

        .loading-subtitle {
            color: var(--gray);
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        .loading-bar-container {
            width: 100%;
            height: 8px;
            background: rgba(255, 215, 0, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .loading-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--gold), var(--gold-dark));
            border-radius: 10px;
            width: 0%;
            transition: width 0.3s ease;
        }

        .loading-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            color: var(--gray);
            font-size: 0.9rem;
        }

        .loading-stat {
            text-align: center;
        }

        .loading-stat-value {
            color: var(--gold);
            font-size: 1.2rem;
            font-weight: 800;
        }

        /* صفحه احراز هویت */
        #authPage {
            min-height: 100vh;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        
        .auth-container {
            background: linear-gradient(145deg, rgba(26, 26, 26, 0.95), rgba(18, 18, 18, 0.95));
            border: 2px solid var(--gold);
            border-radius: 25px;
            padding: 30px 25px;
            width: 100%;
            max-width: 400px;
            box-shadow: 
                0 0 60px rgba(255, 215, 0, 0.3),
                inset 0 0 40px rgba(255, 215, 0, 0.1);
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .auth-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--gold), var(--gold-dark));
        }
        
        .auth-header {
            margin-bottom: 20px;
        }
        
        .auth-icon {
            font-size: 2.5rem;
            color: var(--gold);
            margin-bottom: 10px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .auth-title {
            font-size: 1.8rem;
            color: var(--gold);
            margin-bottom: 8px;
            font-weight: 800;
        }
        
        .auth-subtitle {
            color: var(--gray);
            font-size: 0.85rem;
            margin-bottom: 5px;
        }
        
        /* تب‌های ثبت نام/ورود */
        .auth-tabs {
            display: flex;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 20px;
        }
        
        .auth-tab {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            color: var(--gray);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 700;
            font-size: 0.9rem;
        }
        
        .auth-tab.active {
            background: var(--gold);
            color: var(--black);
            box-shadow: 0 3px 12px rgba(255, 215, 0, 0.4);
        }
        
        /* فرم‌ها */
        .auth-form {
            display: none;
        }
        
        .auth-form.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
            text-align: right;
            position: relative;
        }
        
        .form-label {
            display: block;
            margin-bottom: 6px;
            color: var(--light);
            font-size: 0.85rem;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 45px 12px 14px;
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 10px;
            color: var(--light);
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .password-toggle {
            position: absolute;
            left: 12px;
            top: 35px;
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            padding: 4px;
        }
        
        .password-toggle:hover {
            color: var(--gold);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 12px rgba(255, 215, 0, 0.3);
        }
        
        .auth-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--black);
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.3);
        }
        
        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.4);
        }
        
        .auth-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* وضعیت‌ها و پیام‌ها */
        .auth-message {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.85rem;
            display: none;
        }
        
        .message-success {
            background: rgba(0, 200, 81, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
            display: block;
        }
        
        .message-error {
            background: rgba(255, 68, 68, 0.2);
            color: var(--danger);
            border: 1px solid var(--danger);
            display: block;
        }
        
        .message-info {
            background: rgba(255, 215, 0, 0.2);
            color: var(--warning);
            border: 1px solid var(--warning);
            display: block;
        }
        
        /* صفحه اصلی بازی */
        #gamePage {
            display: none;
            min-height: 100vh;
            padding-bottom: 70px;
        }
        
        /* هدر کوچک‌تر شده */
        .header {
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--gold);
            padding: 10px 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            height: 60px;
        }
        
        .user-stats {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .stat {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255, 215, 0, 0.1);
            padding: 8px 12px;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
            font-size: 0.85rem;
        }
        
        .stat.usdt {
            background: rgba(38, 161, 123, 0.1);
            border: 1px solid rgba(38, 161, 123, 0.3);
        }
        
        .stat.vip {
            background: linear-gradient(135deg, rgba(157, 78, 221, 0.15), rgba(78, 226, 236, 0.15));
            border: 1px solid rgba(157, 78, 221, 0.4);
        }
        
        .stat i {
            color: var(--gold);
            font-size: 0.9rem;
        }
        
        .stat.usdt i {
            color: var(--usdt-color);
        }
        
        .stat.vip i {
            color: var(--vip-purple);
        }
        
        .rock-value {
            font-weight: 700;
            color: var(--gold);
        }
        
        .usdt-value {
            font-weight: 700;
            color: var(--usdt-color);
        }
        
        .user-profile-btn {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid var(--glass-border);
            color: var(--gold);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.1rem;
        }
        
        .user-profile-btn:hover {
            background: rgba(255, 215, 0, 0.2);
            transform: scale(1.1);
        }
        
        /* محتوای اصلی */
        .main-content {
            padding: 15px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* بخش کوه مرکزی - ارتفاع بزرگتر شده */
        .mountain-section {
            background: linear-gradient(135deg, rgba(26, 26, 26, 0.9) 0%, rgba(18, 18, 18, 0.9) 100%);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 15px;
            border: 2px solid var(--glass-border);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.15);
            text-align: center;
            position: relative;
            overflow: hidden;
            height: 380px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
        }
        
        .mountain-title {
            font-size: 2rem;
            margin-bottom: 25px;
            color: var(--gold);
            font-weight: 800;
            text-shadow: 
                0 0 20px rgba(255, 215, 0, 0.8),
                0 0 40px rgba(255, 215, 0, 0.4);
            z-index: 2;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        
        .mountain-container {
            position: relative;
            height: 250px;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            z-index: 2;
        }
        
        /* خورشید پشت کوه */
        .sun {
            position: absolute;
            top: -40px;
            width: 200px;
            height: 200px;
            background: radial-gradient(
                circle at center,
                #FFD700 0%,
                #FFA500 30%,
                #FF8C00 50%,
                transparent 70%
            );
            border-radius: 50%;
            filter: blur(4px);
            animation: sunGlow 4s ease-in-out infinite;
            z-index: 1;
        }
        
        .sun-rays {
            position: absolute;
            top: -60px;
            width: 240px;
            height: 240px;
            background: radial-gradient(
                circle at center,
                rgba(255, 215, 0, 0.4) 0%,
                rgba(255, 165, 0, 0.3) 20%,
                rgba(255, 140, 0, 0.2) 40%,
                transparent 70%
            );
            border-radius: 50%;
            animation: sunRays 6s ease-in-out infinite;
            z-index: 0;
        }
        
        @keyframes sunGlow {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.05); opacity: 1; }
        }
        
        @keyframes sunRays {
            0%, 100% { transform: scale(1); opacity: 0.6; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        
        .mountain {
            position: relative;
            width: 450px;
            height: 220px;
            filter: drop-shadow(0 15px 25px rgba(0, 0, 0, 0.7));
            z-index: 2;
        }
        
        .mountain-base {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(45deg, #1a1a1a 0%, #2d2d2d 25%, #3a3a3a 50%, #2d2d2d 75%, #1a1a1a 100%);
            clip-path: polygon(
                0% 100%, 15% 70%, 28% 85%, 35% 65%, 45% 80%, 
                55% 50%, 65% 70%, 75% 35%, 85% 55%, 95% 75%, 100% 100%
            );
            border-radius: 12px 12px 0 0;
            transform-style: preserve-3d;
            transform: perspective(1000px) rotateX(10deg);
            border: 1px solid rgba(255,215,0,0.2);
        }
        
        .mountain-details {
            position: absolute;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 30% 70%, rgba(255,215,0,0.1) 0%, transparent 50%),
                radial-gradient(circle at 70% 60%, rgba(255,215,0,0.08) 0%, transparent 50%),
                radial-gradient(circle at 50% 40%, rgba(255,215,0,0.05) 0%, transparent 50%);
            clip-path: polygon(
                0% 100%, 15% 70%, 28% 85%, 35% 65%, 45% 80%, 
                55% 50%, 65% 70%, 75% 35%, 85% 55%, 95% 75%, 100% 100%
            );
            border-radius: 12px 12px 0 0;
        }
        
        .mountain-gold {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(45deg, var(--gold-dark) 0%, var(--gold) 30%, var(--gold-light) 70%, #fff8dc 100%);
            clip-path: polygon(
                0% 100%, 15% 70%, 28% 85%, 35% 65%, 45% 80%, 
                55% 50%, 65% 70%, 75% 35%, 85% 55%, 95% 75%, 100% 100%
            );
            border-radius: 12px 12px 0 0;
            transform: perspective(1000px) rotateX(10deg) scaleY(0);
            transform-origin: bottom;
            transition: transform 1.5s ease;
            opacity: 0.9;
            filter: brightness(1.3) contrast(1.2);
            box-shadow: 
                inset 0 0 60px rgba(255,215,0,0.5),
                0 0 40px rgba(255,215,0,0.3);
            border: 2px solid rgba(255,215,0,0.4);
        }
        
        /* ذرات طلایی */
        .gold-particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 3;
        }
        
        .gold-particle {
            position: absolute;
            background: var(--gold);
            border-radius: 50%;
            opacity: 0.8;
            animation: floatParticle 4s infinite ease-in-out;
            filter: blur(0.5px) drop-shadow(0 0 5px rgba(255,215,0,0.8));
        }
        
        @keyframes floatParticle {
            0%, 100% { transform: translateY(0px) rotate(0deg) scale(1); opacity: 0.6; }
            25% { transform: translateY(-15px) rotate(90deg) scale(1.2); opacity: 0.9; }
            50% { transform: translateY(-30px) rotate(180deg) scale(1.4); opacity: 1; }
            75% { transform: translateY(-15px) rotate(270deg) scale(1.2); opacity: 0.9; }
        }
        
        /* بخش استخراج */
        .hammers-section {
            background: linear-gradient(135deg, rgba(26, 26, 26, 0.9) 0%, rgba(18, 18, 18, 0.9) 100%);
            border-radius: 18px;
            padding: 8px;
            margin-bottom: 15px;
            border: 2px solid var(--glass-border);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.12);
            min-height: 110px;
        }
        
        .section-title {
            font-size: 1.3rem;
            color: var(--gold);
            margin-bottom: 15px;
            text-align: center;
            font-weight: 800;
        }
        
        .hammers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 12px;
        }
        
        .hammer-card {
            background: linear-gradient(145deg, rgba(255, 215, 0, 0.08), rgba(26, 26, 26, 0.9));
            border-radius: 16px;
            padding: 5px;
            border: 1.5px solid var(--glass-border);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            min-height: 80px;
            backdrop-filter: blur(10px);
            box-shadow: 
                0 4px 20px rgba(255, 215, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .hammer-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100%;
            background: linear-gradient(180deg, 
                rgba(255, 215, 0, 0.1) 0%, 
                transparent 50%);
            z-index: 1;
            pointer-events: none;
        }

        .hammer-card.active {
            border-color: var(--success);
            box-shadow: 
                0 0 30px rgba(0, 200, 81, 0.3),
                0 4px 20px rgba(0, 200, 81, 0.2);
            transform: translateY(-4px);
        }

        .hammer-card.cooldown {
            border-color: var(--warning);
            box-shadow: 
                0 0 30px rgba(255, 215, 0, 0.3),
                0 4px 20px rgba(255, 215, 0, 0.2);
        }
        
        .hammer-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            position: relative;
            z-index: 2;
        }
        
        .hammer-icon {
            font-size: 2.5rem;
            color: var(--gold);
            text-align: center;
            margin: 12px 0;
            position: relative;
            z-index: 2;
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.5));
            animation: hammerFloat 3s ease-in-out infinite;
        }

        @keyframes hammerFloat {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-5px) rotate(5deg); }
        }
        
        .hammer-name {
            font-size: 1rem;
            font-weight: 800;
            color: var(--gold);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }
        
        .hammer-status {
            padding: 6px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 800;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        
        .status-active {
            background: rgba(0, 200, 81, 0.2);
            color: var(--success);
        }
        
        .status-cooldown {
            background: rgba(255, 215, 0, 0.2);
            color: var(--warning);
        }
        
        .status-ready {
            background: rgba(255, 215, 0, 0.2);
            color: var(--gold);
        }
        
        .hammer-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 0.8rem;
            color: var(--gray);
            font-weight: 700;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border: 1px solid rgba(255, 215, 0, 0.1);
            position: relative;
            z-index: 2;
        }

        .hammer-power {
            color: var(--gold);
            font-weight: 800;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
        }
        
        .hammer-timer {
            text-align: center;
            padding: 10px;
            background: linear-gradient(145deg, rgba(0, 0, 0, 0.5), rgba(255, 215, 0, 0.1));
            border-radius: 10px;
            margin-bottom: 12px;
            font-weight: 700;
            font-size: 0.85rem;
            border: 1px solid var(--glass-border);
            position: relative;
            z-index: 2;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.5);
        }

        .hammer-timer::before {
            content: '⏳';
            margin-left: 5px;
        }
        
        .hammer-actions {
            display: flex;
            gap: 8px;
            position: relative;
            z-index: 2;
        }

        .btn {
            padding: 10px;
            border: none;
            border-radius: 10px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            flex: 1;
            text-align: center;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.2), 
                transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-gold {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--black);
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
        }

        .btn-gold:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.6);
        }
        
        .btn-usdt {
            background: linear-gradient(90deg, var(--usdt-color), #1e8c6d);
            color: var(--light);
        }
        
        .btn-usdt:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(38, 161, 123, 0.35);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        /* بخش تبدیل ارز */
        .conversion-section {
            background: linear-gradient(135deg, rgba(26, 26, 26, 0.9) 0%, rgba(18, 18, 18, 0.9) 100%);
            border-radius: 18px;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid var(--glass-border);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.12);
            display: none;
        }

        .conversion-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .conversion-title {
            font-size: 1.5rem;
            color: var(--gold);
            margin-bottom: 10px;
            font-weight: 800;
        }

        .conversion-subtitle {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .conversion-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            border: 2px solid var(--glass-border);
            margin-bottom: 20px;
        }

        .conversion-rate {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 10px;
            border: 1px solid var(--glass-border);
        }

        .rate-value {
            font-size: 1.4rem;
            color: var(--gold);
            font-weight: 800;
            margin: 10px 0;
        }

        .rate-text {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .conversion-form {
            margin-bottom: 20px;
        }

        .amount-input {
            width: 100%;
            padding: 15px;
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            color: var(--light);
            font-size: 1.1rem;
            text-align: center;
            margin-bottom: 15px;
        }

        .amount-input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }

        .conversion-result {
            text-align: center;
            padding: 15px;
            background: rgba(38, 161, 123, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(38, 161, 123, 0.3);
            margin-bottom: 20px;
        }

        .result-text {
            color: var(--gray);
            margin-bottom: 8px;
        }

        .result-value {
            font-size: 1.3rem;
            color: var(--usdt-color);
            font-weight: 800;
        }

        .conversion-history {
            margin-top: 25px;
        }

        .history-title {
            font-size: 1.1rem;
            color: var(--gold);
            margin-bottom: 15px;
            text-align: center;
        }

        .history-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid var(--glass-border);
        }

        .history-amount {
            font-weight: 700;
        }

        .history-gold {
            color: var(--gold);
        }

        .history-usdt {
            color: var(--usdt-color);
        }

        .history-date {
            color: var(--gray);
            font-size: 0.8rem;
        }
        
        /* بخش پروفایل */
        .profile-section {
            background: linear-gradient(135deg, rgba(26, 26, 26, 0.9) 0%, rgba(18, 18, 18, 0.9) 100%);
            border-radius: 18px;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid var(--glass-border);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.12);
            display: none;
            min-height: auto;
        }
        
        .profile-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .profile-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--black);
            flex-shrink: 0;
        }
        
        .profile-info h3 {
            color: var(--gold);
            margin-bottom: 4px;
            font-size: 0.9rem;
            word-break: break-all;
        }
        
        .profile-info p {
            color: var(--gray);
            font-size: 0.8rem;
        }
        
        .profile-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .profile-stat {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
            text-align: center;
        }
        
        .profile-stat.usdt {
            background: rgba(38, 161, 123, 0.1);
            border: 1px solid rgba(38, 161, 123, 0.3);
        }
        
        .profile-stat-value {
            font-size: 1.2rem;
            color: var(--gold);
            font-weight: 800;
            margin-bottom: 4px;
        }
        
        .profile-stat.usdt .profile-stat-value {
            color: var(--usdt-color);
        }
        
        .profile-stat-label {
            font-size: 0.75rem;
            color: var(--gray);
        }
        
        .profile-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .profile-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
            min-width: 120px;
            margin-bottom: 5px;
        }
        
        .btn-logout {
            background: rgba(255, 68, 68, 0.2);
            color: var(--danger);
            border: 1px solid var(--danger);
        }
        
        .btn-logout:hover {
            background: rgba(255, 68, 68, 0.3);
        }

        .btn-admin {
            background: linear-gradient(135deg, var(--admin-color), #ff4444);
            color: var(--light);
            border: 1px solid var(--admin-color);
        }
        
        .btn-admin:hover {
            background: linear-gradient(135deg, #ff4444, var(--admin-color));
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        /* بخش سیستم VIP */
        .vip-section {
            background: linear-gradient(135deg, rgba(26, 26, 26, 0.95) 0%, rgba(18, 18, 18, 0.95) 100%);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 15px;
            border: 2px solid var(--vip-purple);
            box-shadow: 0 10px 30px rgba(157, 78, 221, 0.2);
            display: none;
        }

        .vip-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .vip-title {
            font-size: 1.8rem;
            color: var(--vip-purple);
            margin-bottom: 10px;
            font-weight: 800;
            text-shadow: 0 0 20px rgba(157, 78, 221, 0.5);
        }

        .vip-subtitle {
            color: var(--gray);
            font-size: 0.9rem;
        }

        /* تایمر VIP */
        .vip-timer-container {
            background: linear-gradient(135deg, 
                rgba(157, 78, 221, 0.1), 
                rgba(78, 226, 236, 0.1));
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            border: 2px solid rgba(157, 78, 221, 0.3);
            text-align: center;
        }

        .vip-timer-title {
            color: var(--vip-purple);
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-weight: 800;
        }

        .vip-timer-display {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--vip-diamond);
            text-shadow: 0 0 15px rgba(78, 226, 236, 0.6);
            margin-bottom: 15px;
            direction: ltr;
        }

        .vip-cycle-info {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        /* تایمر ریست کاربر */
.user-reset-timer-container {
    background: linear-gradient(135deg, 
        rgba(255, 68, 68, 0.1), 
        rgba(255, 107, 107, 0.1));
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 25px;
    border: 2px solid rgba(255, 68, 68, 0.3);
    text-align: center;
    display: none;
}

.user-reset-timer-title {
    color: var(--danger);
    margin-bottom: 15px;
    font-size: 1.1rem;
    font-weight: 800;
}

.user-reset-timer-display {
    font-size: 2.5rem;
    font-weight: 800;
    color: var(--danger);
    text-shadow: 0 0 15px rgba(255, 68, 68, 0.6);
    margin-bottom: 15px;
    direction: ltr;
}

.user-reset-progress-bar {
    width: 100%;
    height: 8px;
    background: rgba(255, 68, 68, 0.2);
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 10px;
}

.user-reset-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--danger), #ff2222);
    border-radius: 10px;
    width: 0%;
    transition: width 0.5s ease;
}

.user-reset-info {
    color: var(--gray);
    font-size: 0.9rem;
    margin-top: 10px;
}

        /* نمودار پیشرفت VIP */
        .vip-progress-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            border: 2px solid var(--glass-border);
        }

        .vip-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .vip-plan-badge {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 800;
        }

        .badge-gold {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--black);
        }

        .badge-diamond {
            background: linear-gradient(135deg, var(--vip-diamond), #26C6DA);
            color: var(--black);
        }

        .vip-progress-bar {
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .vip-progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .progress-gold {
            background: linear-gradient(90deg, var(--gold), var(--gold-dark));
        }

        .progress-diamond {
            background: linear-gradient(90deg, var(--vip-diamond), #26C6DA);
        }

        .vip-progress-stats {
            display: flex;
            justify-content: space-between;
            color: var(--gray);
            font-size: 0.85rem;
        }

        /* کارت‌های پلن VIP */
        .vip-plans-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .vip-plan-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            border: 2px solid;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .vip-plan-card.gold {
            border-color: var(--gold);
            background: linear-gradient(145deg, 
                rgba(255, 215, 0, 0.05), 
                rgba(26, 26, 26, 0.9));
        }

        .vip-plan-card.diamond {
            border-color: var(--vip-diamond);
            background: linear-gradient(145deg, 
                rgba(78, 226, 236, 0.05), 
                rgba(26, 26, 26, 0.9));
        }

        .vip-plan-card.recommended {
            transform: scale(1.02);
            box-shadow: 0 15px 40px rgba(78, 226, 236, 0.2);
        }

        .vip-plan-card.recommended::before {
            content: 'پیشنهادی';
            position: absolute;
            top: 15px;
            left: 15px;
            background: var(--vip-diamond);
            color: var(--black);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 800;
        }

        .plan-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .plan-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .plan-icon.gold {
            color: var(--gold);
        }

        .plan-icon.diamond {
            color: var(--vip-diamond);
        }

        .plan-name {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .plan-name.gold {
            color: var(--gold);
        }

        .plan-name.diamond {
            color: var(--vip-diamond);
        }

        .plan-price {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--light);
            margin-bottom: 20px;
            text-align: center;
        }

        .plan-features {
            list-style: none;
            margin-bottom: 25px;
        }

        .plan-features li {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            color: var(--gray);
            font-size: 0.9rem;
        }

        .plan-features li i {
            color: var(--success);
        }

        .plan-capacity {
            text-align: center;
            font-size: 1.2rem;
            color: var(--light);
            margin-bottom: 20px;
            font-weight: 800;
        }

        /* بخش پرداخت VIP */
        .vip-payment-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid var(--glass-border);
            display: none;
        }

        .payment-wallet {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            word-break: break-all;
            font-family: monospace;
            text-align: center;
            border: 1px solid var(--usdt-color);
        }

        .payment-qr {
            text-align: center;
            margin-bottom: 20px;
        }

        .payment-qr canvas {
            border-radius: 10px;
            border: 2px solid var(--glass-border);
            padding: 10px;
            background: white;
        }

        .payment-instructions {
            color: var(--gray);
            font-size: 0.9rem;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .payment-form {
            margin-bottom: 20px;
        }

        .txid-input {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 10px;
            color: var(--light);
            font-size: 0.9rem;
            text-align: center;
            margin-bottom: 15px;
        }

        .payment-status {
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 15px;
            font-weight: 800;
        }

        .status-pending {
            background: rgba(255, 215, 0, 0.2);
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        .status-active {
            background: rgba(0, 200, 81, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .status-rejected {
            background: rgba(255, 68, 68, 0.2);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        /* مودال محدودیت کاربر عادی */
        .limit-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(10px);
        }

        .limit-container {
            background: linear-gradient(145deg, #0a0a0a, #1a1a1a);
            border: 2px solid var(--danger);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 0 50px rgba(255, 68, 68, 0.3);
        }

        .limit-icon {
            font-size: 4rem;
            color: var(--danger);
            margin-bottom: 20px;
            animation: pulse 1.5s infinite;
        }

        .limit-title {
            font-size: 1.8rem;
            color: var(--danger);
            margin-bottom: 15px;
            font-weight: 800;
        }

        .limit-message {
            color: var(--gray);
            margin-bottom: 25px;
            font-size: 1rem;
            line-height: 1.6;
        }

        /* سیستم ارجاع - بازسازی شده */
        .referral-section {
            background: linear-gradient(135deg, rgba(26, 26, 26, 0.9) 0%, rgba(18, 18, 18, 0.9) 100%);
            border-radius: 20px;
            padding: 25px;
            margin: 15px;
            border: 2px solid var(--gold);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.15);
            display: none;
        }

        .referral-hero {
            text-align: center;
            margin-bottom: 30px;
        }

        .referral-hero h2 {
            font-size: 1.8rem;
            color: var(--gold);
            margin-bottom: 10px;
            font-weight: 800;
        }

        .referral-hero p {
            color: var(--gray);
            font-size: 1rem;
        }

        .your-code, .your-earnings {
            background: rgba(255, 215, 0, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--glass-border);
        }

        .your-code h4, .your-earnings h4 {
            color: var(--gold);
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-weight: 800;
        }

        .code-box, .earnings-box {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--glass-border);
        }

        .code-box span {
            font-family: monospace;
            font-size: 1.2rem;
            color: var(--gold);
            font-weight: 800;
            letter-spacing: 2px;
        }

        .code-box button {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--black);
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s;
        }

        .code-box button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
        }

        .earnings-box span {
            font-size: 2rem;
            color: var(--gold);
            font-weight: 800;
        }

        .invite-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 30px;
        }

        .invite-buttons button {
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
            border: 1px solid var(--glass-border);
        }

        .invite-buttons button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 215, 0, 0.2);
        }

        .invite-buttons button:nth-child(1) {
            background: linear-gradient(135deg, #25D366, #128C7E);
        }

        .invite-buttons button:nth-child(2) {
            background: linear-gradient(135deg, #0088cc, #005e8c);
        }

        .invite-buttons button:nth-child(3) {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--black);
        }

        .referral-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid var(--glass-border);
        }

        .referral-info h4 {
            color: var(--gold);
            margin-bottom: 20px;
            font-size: 1.2rem;
            text-align: center;
            font-weight: 800;
        }

        .info-steps {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .info-step {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
        }

        .step-number {
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--black);
            font-weight: 800;
            flex-shrink: 0;
        }

        .step-text {
            color: var(--light);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .step-text strong {
            color: var(--gold);
        }

        .referral-list {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid var(--glass-border);
        }

        .referral-list h4 {
            color: var(--gold);
            margin-bottom: 20px;
            font-size: 1.2rem;
            text-align: center;
            font-weight: 800;
        }

        .referral-list-container {
            max-height: 300px;
            overflow-y: auto;
        }

        .referral-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 215, 0, 0.1);
        }

        .referral-item:last-child {
            margin-bottom: 0;
        }

        .referral-email {
            color: var(--light);
            font-weight: 700;
        }

        .referral-date {
            color: var(--gray);
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .referral-reward {
            color: var(--gold);
            font-weight: 800;
            font-size: 1.1rem;
        }
        
        /* بخش سطح‌بندی - اصلاح شده */
        .levels-section {
            background: linear-gradient(135deg, rgba(26, 26, 26, 0.9) 0%, rgba(18, 18, 18, 0.9) 100%);
            border-radius: 18px;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid var(--glass-border);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.12);
            display: none;
        }

        .levels-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .levels-title {
            font-size: 1.5rem;
            color: var(--gold);
            margin-bottom: 10px;
            font-weight: 800;
        }

        .levels-subtitle {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .current-level-info {
            background: rgba(255, 215, 0, 0.1);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            margin-bottom: 20px;
            text-align: center;
        }

        .current-level-text {
            font-size: 1rem;
            color: var(--gold);
            margin-bottom: 5px;
        }

        .current-level-value {
            font-size: 2.5rem;
            color: var(--gold);
            font-weight: 800;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
            margin-bottom: 15px;
        }

        .level-progress {
            margin-top: 15px;
        }

        .progress-text {
            font-size: 0.9rem;
            color: var(--gray);
            margin-bottom: 8px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 215, 0, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gold), var(--gold-dark));
            border-radius: 10px;
            width: 0%;
            transition: width 0.5s ease;
        }

        .levels-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .level-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            border: 2px solid var(--glass-border);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .level-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, var(--gold), var(--gold-dark));
        }

        .level-card.current {
            border-color: var(--gold);
            background: rgba(255, 215, 0, 0.1);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
            transform: scale(1.02);
        }

        .level-card.unlocked {
            border-color: var(--success);
            background: rgba(0, 200, 81, 0.05);
        }

        .level-card.locked {
            border-color: var(--gray);
            background: rgba(140, 140, 140, 0.05);
            opacity: 0.7;
        }

        .level-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .level-name {
            font-size: 1.3rem;
            color: var(--gold);
            font-weight: 800;
        }

        .level-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .badge-current {
            background: rgba(255, 215, 0, 0.2);
            color: var(--gold);
        }

        .badge-unlocked {
            background: rgba(0, 200, 81, 0.2);
            color: var(--success);
        }

        .badge-locked {
            background: rgba(140, 140, 140, 0.2);
            color: var(--gray);
        }

        .level-icon {
            font-size: 3rem;
            text-align: center;
            margin: 20px 0;
            color: var(--gold);
        }

        .level-stats {
            margin-bottom: 20px;
        }

        .level-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 215, 0, 0.1);
        }

        .stat-label {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .stat-value {
            color: var(--gold);
            font-weight: 700;
            font-size: 1rem;
        }

        .level-price {
            text-align: center;
            font-size: 1.3rem;
            color: var(--gold);
            margin: 25px 0;
            font-weight: 800;
            background: rgba(255, 215, 0, 0.1);
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
        }

        .level-actions {
            display: flex;
            gap: 10px;
        }

        .level-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .level-btn.primary {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--black);
        }

        .level-btn.primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }

        .level-btn.primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .level-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
            border: 1px solid var(--glass-border);
        }

        .level-up-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,215,0,0.3) 0%, transparent 70%);
            animation: levelUpPulse 1s ease-out;
            border-radius: 15px;
            z-index: 2;
        }

        @keyframes levelUpPulse {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 0; }
        }

        /* تأیید چند مرحله‌ای - اصلاح شده */
        .confirmation-grid {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(10px);
        }
        
        .verification-container {
            background: linear-gradient(145deg, #0a0a0a, #1a1a1a);
            border: 2px solid var(--gold);
            border-radius: 18px;
            padding: 25px;
            text-align: center;
            box-shadow: 
                0 0 40px rgba(255, 215, 0, 0.25),
                inset 0 0 25px rgba(255, 215, 0, 0.08);
            max-width: 380px;
            width: 90%;
            position: relative;
            overflow: hidden;
        }
        
        .verification-header {
            margin-bottom: 20px;
        }
        
        .verification-icon {
            font-size: 2.5rem;
            color: var(--gold);
            margin-bottom: 15px;
            animation: pulse 2s infinite;
        }
        
        .verification-title {
            font-size: 1.3rem;
            color: var(--gold);
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .verification-subtitle {
            font-size: 0.9rem;
            color: var(--gray);
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .hash-display {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            padding: 12px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            color: var(--gold-light);
            text-align: center;
            direction: ltr;
            word-break: break-all;
            box-shadow: inset 0 0 12px rgba(255,215,0,0.08);
            font-weight: 700;
        }
        
        .verification-steps {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            position: relative;
        }
        
        .verification-steps::before {
            content: '';
            position: absolute;
            top: 18px;
            left: 10%;
            right: 10%;
            height: 2px;
            background: rgba(255, 215, 0, 0.3);
            z-index: 1;
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 2;
            flex: 1;
        }
        
        .step-circle {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: rgba(255, 215, 0, 0.2);
            border: 2px solid rgba(255, 215, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .step-circle.active {
            background: var(--gold);
            border-color: var(--gold);
            box-shadow: 0 0 12px rgba(255, 215, 0, 0.5);
        }
        
        .step-circle.completed {
            background: var(--success);
            border-color: var(--success);
        }
        
        .step-circle i {
            color: var(--light);
            font-size: 1rem;
        }
        
        .step-label {
            font-size: 0.75rem;
            color: var(--gray);
            text-align: center;
            font-weight: 700;
        }
        
        .step.active .step-label {
            color: var(--gold);
            font-weight: 700;
        }
        
        .verification-timer {
            font-size: 2rem;
            color: var(--gold);
            font-weight: 700;
            margin: 15px 0;
            text-shadow: 0 0 8px rgba(255, 215, 0, 0.4);
        }
        
        .verification-reward {
            font-size: 1.7rem;
            color: var(--gold);
            font-weight: 800;
            margin: 15px 0;
            text-shadow: 0 0 12px rgba(255, 215, 0, 0.6);
            background: linear-gradient(45deg, var(--gold), var(--gold-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .verification-btn {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--black);
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 15px;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.25);
        }
        
        .verification-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.35);
        }
        
        .verification-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* نویگیشن پایین - اصلاح شده */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(15px);
            border-top: 1px solid var(--gold);
            padding: 10px 5%;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 100;
            height: 60px;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.3s;
            padding: 8px 12px;
            border-radius: 12px;
            min-width: 70px;
        }
        
        .nav-item.active {
            background: rgba(255, 215, 0, 0.15);
        }
        
        .nav-item i {
            font-size: 1.2rem;
            color: var(--gray);
            transition: all 0.3s;
        }
        
        .nav-item.active i {
            color: var(--gold);
        }
        
        .nav-item span {
            font-size: 0.75rem;
            color: var(--gray);
            transition: all 0.3s;
            font-weight: 700;
        }
        
        .nav-item.active span {
            color: var(--gold);
            font-weight: 700;
        }
        
        .nav-item:hover {
            background: rgba(255, 215, 0, 0.1);
        }

        /* لودینگ */
        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 50%;
            border-top-color: var(--gold);
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* پیام لاگین */
        .login-message {
            text-align: center;
            padding: 20px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 12px;
            margin: 20px 0;
            border: 1px solid var(--glass-border);
        }
        
        .login-btn {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--black);
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.25);
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.35);
        }

        /* پنل ادمین - جدید */
        .admin-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.97);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            backdrop-filter: blur(15px);
        }

        .admin-container {
            background: linear-gradient(145deg, #0a0a0a, #1a1a1a);
            border: 2px solid var(--admin-color);
            border-radius: 20px;
            padding: 30px;
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 0 60px rgba(255, 107, 107, 0.3);
        }

        .admin-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255, 107, 107, 0.3);
        }

        .admin-title {
            font-size: 2.2rem;
            color: var(--admin-color);
            margin-bottom: 10px;
            font-weight: 800;
            text-shadow: 0 0 15px rgba(255, 107, 107, 0.5);
        }

        .admin-subtitle {
            color: var(--gray);
            font-size: 0.95rem;
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .admin-stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--glass-border);
        }

        .admin-stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 10px;
        }

        .admin-stat-label {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .stat-vip {
            color: var(--vip-purple);
        }

        .stat-pending {
            color: var(--warning);
        }

        .stat-total {
            color: var(--gold);
        }

        .stat-revenue {
            color: var(--usdt-color);
        }

        .admin-tabs {
            display: flex;
            background: rgba(255, 107, 107, 0.1);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 25px;
            overflow-x: auto;
        }

        .admin-tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            color: var(--gray);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 700;
            font-size: 0.9rem;
            min-width: 120px;
            white-space: nowrap;
        }

        .admin-tab.active {
            background: var(--admin-color);
            color: var(--light);
            box-shadow: 0 3px 12px rgba(255, 107, 107, 0.4);
        }

        .admin-tab-content {
            display: none;
        }

        .admin-tab-content.active {
            display: block;
        }

        .admin-table-container {
            overflow-x: auto;
            margin-bottom: 20px;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.05);
        }

        .admin-table th {
            background: rgba(255, 107, 107, 0.2);
            color: var(--admin-color);
            padding: 18px 15px;
            text-align: right;
            font-weight: 800;
            border-bottom: 2px solid rgba(255, 107, 107, 0.3);
            font-size: 0.9rem;
        }

        .admin-table td {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            color: var(--light);
            font-size: 0.85rem;
        }

        .admin-table tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .admin-table tr:last-child td {
            border-bottom: none;
        }

        .user-email {
            color: var(--gold);
            font-weight: 700;
            word-break: break-all;
        }

        .user-plan {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            display: inline-block;
        }

        .plan-gold {
            background: rgba(255, 215, 0, 0.2);
            color: var(--gold);
        }

        .plan-diamond {
            background: rgba(78, 226, 236, 0.2);
            color: var(--vip-diamond);
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            display: inline-block;
        }

        .status-pending-badge {
            background: rgba(255, 215, 0, 0.2);
            color: var(--warning);
        }

        .status-confirmed-badge {
            background: rgba(0, 200, 81, 0.2);
            color: var(--success);
        }

        .status-rejected-badge {
            background: rgba(255, 68, 68, 0.2);
            color: var(--danger);
        }

        .status-inactive-badge {
            background: rgba(140, 140, 140, 0.2);
            color: var(--gray);
        }

        .status-active-badge {
            background: rgba(157, 78, 221, 0.2);
            color: var(--vip-purple);
        }

        .admin-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-approve {
            background: rgba(0, 200, 81, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .btn-approve:hover {
            background: rgba(0, 200, 81, 0.3);
            transform: translateY(-2px);
        }

        .btn-reject {
            background: rgba(255, 68, 68, 0.2);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .btn-reject:hover {
            background: rgba(255, 68, 68, 0.3);
            transform: translateY(-2px);
        }

        .btn-view {
            background: rgba(255, 215, 0, 0.2);
            color: var(--gold);
            border: 1px solid var(--gold);
        }

        .btn-view:hover {
            background: rgba(255, 215, 0, 0.3);
            transform: translateY(-2px);
        }

        .txid-cell {
            font-family: monospace;
            font-size: 0.8rem;
            color: var(--gold-light);
            word-break: break-all;
            max-width: 200px;
        }

        .date-cell {
            color: var(--gray);
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: var(--gray);
            font-size: 1rem;
        }

        .admin-close-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid var(--admin-color);
            color: var(--admin-color);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
        }

        .admin-close-btn:hover {
            background: rgba(255, 107, 107, 0.3);
            transform: scale(1.1);
        }

        .admin-refresh-btn {
            background: linear-gradient(135deg, var(--admin-color), #ff4444);
            color: var(--light);
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .admin-refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        /* ریسپانسیو */
        @media (max-width: 768px) {
            .mountain {
                width: 350px;
                height: 180px;
            }
            
            .mountain-container {
                height: 200px;
            }
            
            .mountain-title {
                font-size: 1.7rem;
            }
            
            .mountain-section {
                height: 320px;
                padding: 20px;
            }
            
            .sun {
                top: -30px;
                width: 160px;
                height: 160px;
            }
            
            .sun-rays {
                top: -50px;
                width: 200px;
                height: 200px;
            }
            
            .hammers-grid {
                grid-template-columns: 1fr;
            }
            
            .vip-plans-grid {
                grid-template-columns: 1fr;
            }
            
            .levels-grid {
                grid-template-columns: 1fr;
            }
            
            .auth-container {
                padding: 25px 20px;
            }
            
            .header {
                padding: 8px 4%;
                height: 55px;
            }
            
            .user-stats {
                gap: 8px;
            }
            
            .stat {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
            
            .nav-item {
                min-width: 65px;
                padding: 6px 10px;
            }
            
            .nav-item i {
                font-size: 1.1rem;
            }
            
            .nav-item span {
                font-size: 0.7rem;
            }
            
            .vip-timer-display {
                font-size: 2rem;
            }
            
            .vip-plan-card.recommended::before {
                top: 10px;
                left: 10px;
                font-size: 0.6rem;
                padding: 4px 8px;
            }
            
            .admin-table {
                font-size: 0.8rem;
            }
            
            .admin-table th,
            .admin-table td {
                padding: 10px 8px;
            }
            
            .admin-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .admin-stat-value {
                font-size: 2rem;
            }
            
            .admin-tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
                justify-content: flex-start;
            }
            
            .admin-tab {
                min-width: 100px;
                font-size: 0.8rem;
                padding: 10px;
            }
            
            .referral-section {
                margin: 10px;
                padding: 20px;
            }
            
            .invite-buttons {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .mountain {
                width: 300px;
                height: 150px;
            }
            
            .mountain-container {
                height: 170px;
            }
            
            .mountain-title {
                font-size: 1.4rem;
            }
            
            .mountain-section {
                height: 280px;
                padding: 15px;
            }
            
            .sun {
                top: -25px;
                width: 130px;
                height: 130px;
            }
            
            .sun-rays {
                top: -40px;
                width: 170px;
                height: 170px;
            }
            
            .main-content {
                padding: 12px;
            }
            
            .header {
                padding: 8px 3%;
                height: 50px;
            }
            
            .user-stats {
                flex-wrap: wrap;
                gap: 6px;
            }
            
            .auth-title {
                font-size: 1.5rem;
            }
            
            .auth-icon {
                font-size: 2.2rem;
            }
            
            .nav-item {
                min-width: 60px;
                padding: 5px 8px;
            }
            
            .nav-item i {
                font-size: 1rem;
            }
            
            .nav-item span {
                font-size: 0.65rem;
            }
            
            .vip-title {
                font-size: 1.4rem;
            }
            
            .vip-timer-display {
                font-size: 1.8rem;
            }
            
            .admin-table {
                font-size: 0.7rem;
            }
            
            .admin-stats {
                grid-template-columns: 1fr;
            }
            
            .admin-container {
                padding: 20px 15px;
                width: 98%;
            }
            
            .admin-title {
                font-size: 1.8rem;
            }
            
            .admin-actions {
                flex-direction: column;
                gap: 5px;
            }
            
            .action-btn {
                padding: 6px;
                font-size: 0.7rem;
            }
            
            .profile-actions {
                flex-direction: column;
            }
            
            .profile-btn {
                width: 100%;
            }
        }
        /* مخفی کردن آیکون ساعت (چهارمین child) */
.header .user-stats .stat:nth-child(4) {
    display: none !important;
}
/* فقط آیکون تاج، نوشته مخفی */
#vipStatBadge span {
    display: none !important;
}

/* اندازه همون قبلی، فقط تاج وسط */
#vipStatBadge {
    justify-content: center;
    padding: 9px 12px !important; /* اندازه اصلی */
    width: auto !important;
    min-width: unset !important;
}

/* اگر میخوای آیکون کمی بزرگتر باشه */
#vipStatBadge i {
    font-size: 0.9rem !important;
    margin: 0 !important;
}
    </style>
</head>
<body>
    <!-- سیستم نوتیفیکیشن -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- مودال محدودیت کاربر عادی -->
    <div class="limit-modal" id="limitModal">
        <div class="limit-container">
            <div class="limit-icon">
                <i class="fas fa-lock"></i>
            </div>
            <h2 class="limit-title">⚠️ دسترسی محدود شده!</h2>
            <p class="limit-message">
                شما به سقف استخراج کاربر عادی (۳ میلیون سکه) رسیده‌اید.<br>
                برای ادامه استخراج باید یکی از پلن‌های VIP را خریداری کنید.
            </p>
            <button class="btn btn-gold" onclick="showSection('vip')" style="padding: 15px 30px; font-size: 1.1rem;">
                <i class="fas fa-crown"></i> مشاهده پلن‌های VIP
            </button>
        </div>
    </div>

    <!-- پنل ادمین -->
    <div class="admin-panel" id="adminPanel">
        <div class="admin-container">
            <div class="admin-close-btn" onclick="closeAdminPanel()">
                <i class="fas fa-times"></i>
            </div>
            
            <div class="admin-header">
                <h1 class="admin-title"><i class="fas fa-user-shield"></i> پنل مدیریت</h1>
                <p class="admin-subtitle">مدیریت کاربران و درخواست‌های VIP</p>
            </div>

            <div class="admin-stats" id="adminStats">
                <!-- آمار توسط جاوااسکریپت پر می‌شود -->
            </div>

            <button class="admin-refresh-btn" onclick="loadAdminData()">
                <i class="fas fa-sync-alt"></i> بروزرسانی اطلاعات
            </button>

            <div class="admin-tabs">
                <button class="admin-tab active" onclick="showAdminTab('pending')">
                    <i class="fas fa-clock"></i> در انتظار تایید
                </button>
                <button class="admin-tab" onclick="showAdminTab('vip')">
                    <i class="fas fa-crown"></i> کاربران VIP
                </button>
                <button class="admin-tab" onclick="showAdminTab('payments')">
                    <i class="fas fa-money-check-alt"></i> پرداخت‌ها
                </button>
                <button class="admin-tab" onclick="showAdminTab('users')">
                    <i class="fas fa-users"></i> همه کاربران
                </button>
            </div>

            <!-- تب درخواست‌های در انتظار -->
            <div class="admin-tab-content active" id="pendingTab">
                <div class="admin-table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>کاربر</th>
                                <th>پلن</th>
                                <th>مبلغ</th>
                                <th>TXID</th>
                                <th>تاریخ</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="pendingRequestsTable">
                            <!-- داده‌ها توسط جاوااسکریپت پر می‌شود -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- تب کاربران VIP -->
            <div class="admin-tab-content" id="vipTab">
                <div class="admin-table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>کاربر</th>
                                <th>پلن</th>
                                <th>وضعیت</th>
                                <th>سقف استخراج</th>
                                <th>تاریخ خرید</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="vipUsersTable">
                            <!-- داده‌ها توسط جاوااسکریپت پر می‌شود -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- تب پرداخت‌ها -->
            <div class="admin-tab-content" id="paymentsTab">
                <div class="admin-table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>کاربر</th>
                                <th>پلن</th>
                                <th>مبلغ</th>
                                <th>TXID</th>
                                <th>وضعیت</th>
                                <th>تاریخ</th>
                                <th>تایید شده توسط</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsTable">
                            <!-- داده‌ها توسط جاوااسکریپت پر می‌شود -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- تب همه کاربران -->
            <div class="admin-tab-content" id="usersTab">
                <div class="admin-table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>کاربر</th>
                                <th>موجودی طلا</th>
                                <th>سطح</th>
                                <th>وضعیت VIP</th>
                                <th>تاریخ عضویت</th>
                                <th>تعداد زیرمجموعه</th>
                            </tr>
                        </thead>
                        <tbody id="allUsersTable">
                            <!-- داده‌ها توسط جاوااسکریپت پر می‌شود -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- صفحه لودینگ -->
    <div id="loadingPage">
        <div class="loading-container">
            <div class="loading-logo">
                <i class="fas fa-mountain"></i>
            </div>
            <h1 class="loading-title">معدن‌چی طلا</h1>
            <p class="loading-subtitle">در حال بارگذاری جهان طلایی...</p>
            
            <div class="loading-bar-container">
                <div class="loading-bar" id="loadingBar"></div>
            </div>
            
            <div class="loading-stats">
                <div class="loading-stat">
                    <div class="loading-stat-value" id="loadingPercent">0%</div>
                    <div>پیشرفت</div>
                </div>
                <div class="loading-stat">
                    <div class="loading-stat-value" id="loadingAssets">0/5</div>
                    <div>شبکه</div>
                </div>
            </div>
        </div>
    </div>

    <!-- صفحه احراز هویت -->
    <div id="authPage">
        <div class="auth-container">
            <div class="auth-header">
                <div class="auth-icon">
                    <i class="fas fa-mountain"></i>
                </div>
                <h1 class="auth-title">معدن‌چی طلا</h1>
                <p class="auth-subtitle">برای شروع بازی ثبت نام کنید</p>
            </div>
            
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showTab('register')">ثبت نام</button>
                <button class="auth-tab" onclick="showTab('login')">ورود</button>
            </div>
            
            <div class="auth-message" id="authMessage"></div>
            
            <form class="auth-form active" id="registerForm">
                <div class="form-group">
                    <label class="form-label">ایمیل</label>
                    <input type="email" class="form-input" id="registerEmail" placeholder="example@gmail.com" required>
                </div>
                <div class="form-group">
                    <label class="form-label">رمز عبور</label>
                    <input type="password" class="form-input" id="registerPassword" placeholder="حداقل ۶ کاراکتر" required minlength="6">
                    <button type="button" class="password-toggle" onclick="togglePassword('registerPassword', this)">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-gift"></i> کد معرف دوستتان (اختیاری)
                    </label>
                    <input type="text" class="form-input" id="referralCode" placeholder="کد دوستتان را وارد کنید" maxlength="10">
                </div>
                <button type="submit" class="auth-btn" id="registerBtn">
                    ثبت نام و شروع بازی
                </button>
            </form>
            
            <form class="auth-form" id="loginForm">
                <div class="form-group">
                    <label class="form-label">ایمیل</label>
                    <input type="email" class="form-input" id="loginEmail" placeholder="example@gmail.com" required>
                </div>
                <div class="form-group">
                    <label class="form-label">رمز عبور</label>
                    <input type="password" class="form-input" id="loginPassword" placeholder="رمز عبور خود را وارد کنید" required>
                    <button type="button" class="password-toggle" onclick="togglePassword('loginPassword', this)">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <button type="submit" class="auth-btn" id="loginBtn">
                    ورود به بازی
                </button>
            </form>
        </div>
    </div>

    <!-- صفحه اصلی بازی -->
    <div id="gamePage">
        <!-- هدر -->
        <header class="header">
            <div class="user-stats">
                <div class="stat">
                    <i class="fas fa-gem"></i>
                    <span class="rock-value" id="rockBalance">0</span>
                </div>
                <div class="stat usdt">
                    <i class="fas fa-coins"></i>
                    <span class="usdt-value" id="usdtBalance">0</span>
                </div>
                <div class="stat" id="vipStatBadge" style="display: none;">
                    <i class="fas fa-crown"></i>
                    <span id="vipPlanName">VIP</span>
                </div>
                <div class="stat">
                    <i class="fas fa-clock"></i>
                    <span id="activeTimers">0</span>
                </div>
            </div>
            <div class="user-profile-btn" onclick="showSection('profile')">
                <i class="fas fa-user"></i>
            </div>
        </header>
        
        <!-- محتوای اصلی -->
        <div class="main-content">
            <!-- بخش کوه مرکزی -->
            <section class="mountain-section" id="mountainSection">
                <h2 class="mountain-title">GOLD COIN</h2>
                
                <div class="mountain-container">
                    <div class="sun-rays"></div>
                    <div class="sun"></div>
                    
                    <div class="mountain">
                        <div class="mountain-base"></div>
                        <div class="mountain-details"></div>
                        <div class="mountain-gold" id="mountainGold"></div>
                    </div>
                </div>
                
                <div class="gold-particles" id="goldParticles"></div>
            </section>
            
            <!-- بخش VIP -->
            <section class="vip-section" id="vipSection">
                <div class="vip-header">
                    <h2 class="vip-title"><i class="fas fa-crown"></i> سیستم VIP</h2>
                    <p class="vip-subtitle">ارتقاء دهید و بدون محدودیت استخراج کنید</p>
                </div>

                <!-- تایمر و نمودار پیشرفت -->
                <div class="vip-timer-container" id="vipTimerContainer" style="display: none;">
                    <div class="vip-cycle-info" id="vipCycleInfo">
                        <span id="currentCycleMined">0</span> از <span id="cycleCap">0</span> سکه استخراج شده
                    </div>
                </div>
                
                <!-- تایمر ریست کاربر VIP -->
<div class="user-reset-timer-container" id="userResetTimerContainer">
    <div class="user-reset-timer-title">⏳ تایمر ریست سقف شما</div>
    <div class="user-reset-timer-display" id="userResetTimerDisplay">00:00</div>
    
    <div class="user-reset-progress-bar">
        <div class="user-reset-progress-fill" id="userResetProgressFill"></div>
    </div>
    
    <div class="user-reset-info" id="userResetInfo">
        بعد از اتمام تایمر، سقف شما ریست می‌شود
    </div>
</div>

                <div class="vip-progress-container" id="vipProgressContainer" style="display: none;">
                    <div class="vip-progress-header">
                        <div>پیشرفت در سیکل فعلی</div>
                        <div class="vip-plan-badge" id="vipPlanBadge">طلایی</div>
                    </div>
                    <div class="vip-progress-bar">
                        <div class="vip-progress-fill" id="vipProgressFill"></div>
                    </div>
                    <div class="vip-progress-stats">
                        <span id="vipProgressText">0%</span>
                        <span id="vipCapRemaining">3,000,000 سکه باقی‌مانده</span>
                    </div>
                </div>

                <!-- پلن‌های VIP -->
                <div class="vip-plans-grid" id="vipPlansGrid">
                    <!-- پلن طلایی -->
                    <div class="vip-plan-card gold" id="goldPlanCard">
                        <div class="plan-header">
                            <div class="plan-icon gold">
                                <i class="fas fa-crown"></i>
                            </div>
                            <h3 class="plan-name gold">پلن طلایی</h3>
                            <div class="plan-capacity" id="goldPlanCap">سقف: ۳,۰۰۰,۰۰۰ سکه</div>
                        </div>
                        
                        <div class="plan-price" id="goldPlanPrice">۱۰ USDT</div>
                        
                        <ul class="plan-features">
                            <li><i class="fas fa-check"></i> سقف ۳ میلیون در هر سیکل</li>
                            <li><i class="fas fa-check"></i> تایمر ۵ دقیقه‌ای</li>
                            <li><i class="fas fa-check"></i> ریست خودکار سقف</li>
                            <li><i class="fas fa-check"></i> دائمی و همیشگی</li>
                            <li><i class="fas fa-check"></i> امکان ارتقاء به الماس</li>
                        </ul>
                        
                        <button class="btn btn-gold" onclick="selectVIPPlan('gold')" id="goldPlanBtn" style="width: 100%; padding: 12px;">
                            <i class="fas fa-shopping-cart"></i> خرید پلن طلایی
                        </button>
                    </div>

                    <!-- پلن الماس -->
                    <div class="vip-plan-card diamond recommended" id="diamondPlanCard">
                        <div class="plan-header">
                            <div class="plan-icon diamond">
                                <i class="fas fa-gem"></i>
                            </div>
                            <h3 class="plan-name diamond">پلن الماس</h3>
                            <div class="plan-capacity" id="diamondPlanCap">سقف: ۶,۰۰۰,۰۰۰ سکه</div>
                        </div>
                        
                        <div class="plan-price" id="diamondPlanPrice">۲۰ USDT</div>
                        
                        <ul class="plan-features">
                            <li><i class="fas fa-check"></i> سقف ۶ میلیون در هر سیکل</li>
                            <li><i class="fas fa-check"></i> تایمر ۵ دقیقه‌ای</li>
                            <li><i class="fas fa-check"></i> ریست خودکار سقف</li>
                            <li><i class="fas fa-check"></i> دائمی و همیشگی</li>
                            <li><i class="fas fa-check"></i> بهترین پلن پیشنهادی</li>
                        </ul>
                        
                        <button class="btn" onclick="selectVIPPlan('diamond')" id="diamondPlanBtn" style="width: 100%; padding: 12px; background: linear-gradient(135deg, var(--vip-diamond), #26C6DA); color: var(--black);">
                            <i class="fas fa-shopping-cart"></i> خرید پلن الماس
                        </button>
                    </div>
                </div>

                <!-- بخش پرداخت -->
                <div class="vip-payment-container" id="vipPaymentContainer">
                    <h3 style="color: var(--gold); margin-bottom: 20px; text-align: center;">
                        <i class="fas fa-wallet"></i> پرداخت USDT (BEP20)
                    </h3>
                    
                    <div class="payment-wallet" id="paymentWallet">
                        در حال بارگذاری آدرس کیف پول...
                    </div>
                    
                    <div class="payment-instructions">
                        <p><strong>مراحل پرداخت:</strong></p>
                        <ol style="text-align: right; margin-right: 15px;">
                            <li>مبلغ دقیق را به آدرس بالا ارسال کنید</li>
                            <li>پس از پرداخت، TXID تراکنش را وارد نمایید</li>
                            <li>تایید تراکنش توسط ادمین انجام خواهد شد</li>
                            <li>بعد از تایید، پلن VIP فعال می‌شود</li>
                        </ol>
                        <p style="color: var(--warning); margin-top: 10px;">
                            ⚠️ توجه: تراکنش‌ها توسط ادمین بررسی می‌شوند. ممکن است تا ۲۴ ساعت زمان ببرد.
                        </p>
                    </div>
                    
                    <div class="payment-form">
                        <input type="text" class="txid-input" id="txidInput" placeholder="TXID تراکنش خود را وارد کنید" maxlength="100">
                        <div class="payment-status" id="paymentStatus" style="display: none;">
                            وضعیت: <span id="statusText">در انتظار</span>
                        </div>
                        <button class="btn btn-usdt" onclick="submitPayment()" id="submitPaymentBtn" style="width: 100%; padding: 12px;">
                            <i class="fas fa-paper-plane"></i> ارسال برای بررسی
                        </button>
                        <button class="btn" onclick="cancelPayment()" style="width: 100%; padding: 12px; margin-top: 10px; background: rgba(255, 68, 68, 0.2); color: var(--danger); border: 1px solid var(--danger);">
                            <i class="fas fa-times"></i> انصراف
                        </button>
                    </div>
                </div>

                <!-- وضعیت فعلی کاربر -->
                <div id="userVIPStatus" style="text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 10px; margin-top: 20px;">
                    <div id="normalUserStatus">
                        <h4 style="color: var(--gray); margin-bottom: 10px;">🔒 وضعیت فعلی: کاربر عادی</h4>
                        <p style="color: var(--warning); font-size: 0.9rem;">
                            سقف استخراج شما: ۳,۰۰۰,۰۰۰ سکه (کلی)<br>
                            <span id="normalUserProgress">۰ از ۳,۰۰۰,۰۰۰ سکه استخراج شده</span>
                        </p>
                    </div>
                    <div id="vipUserStatus" style="display: none;">
                        <h4 style="color: var(--vip-purple); margin-bottom: 10px;">🎉 وضعیت فعلی: <span id="currentVIPPlanName">VIP</span></h4>
                        <p style="color: var(--success); font-size: 0.9rem;">
                            پلن شما فعال است! می‌توانید بدون محدودیت زمانی استخراج کنید.
                        </p>
                    </div>
                    <div id="pendingVIPStatus" style="display: none;">
                        <h4 style="color: var(--warning); margin-bottom: 10px;">⏳ در انتظار تایید</h4>
                        <p style="color: var(--warning); font-size: 0.9rem;">
                            پرداخت شما در انتظار تایید ادمین است.<br>
                            لطفاً صبر کنید...
                        </p>
                    </div>
                </div>
            </section>
            
            <!-- بخش تبدیل ارز -->
            <section class="conversion-section" id="conversionSection">
                <div class="conversion-header">
                    <h2 class="conversion-title">تبدیل ارز</h2>
                    <p class="conversion-subtitle">سکه‌های طلای خود را به تتر تبدیل کنید</p>
                </div>
                
                <div class="conversion-card">
                    <div class="conversion-rate">
                        <div class="rate-text">نرخ تبدیل فعلی</div>
                        <div class="rate-value" id="conversionRate">GOLD = 0.00001</div>
                        <div class="rate-text">هر ۱۰۰,۰۰۰ سکه طلا معادل ۱ تتر</div>
                    </div>
                    
                    <div class="conversion-form">
                        <input type="number" class="amount-input" id="goldAmount" placeholder="مقدار طلا برای تبدیل" min="1" max="1000000">
                        <div class="conversion-result">
                            <div class="result-text">دریافت خواهید کرد:</div>
                            <div class="result-value" id="usdtResult">0 USDT</div>
                        </div>
                        <button class="btn btn-usdt" onclick="convertGoldToUSDT()" style="width: 100%; padding: 12px;">
                            <i class="fas fa-exchange-alt"></i> تبدیل به تتر
                        </button>
                    </div>
                </div>
                
                <div class="conversion-history">
                    <h3 class="history-title">تاریخچه تبدیل‌ها</h3>
                    <div class="history-list" id="conversionHistory">
                        <!-- تاریخچه تبدیل‌ها اینجا نمایش داده می‌شود -->
                    </div>
                </div>
            </section>
            
            <!-- بخش پروفایل -->
            <section class="profile-section" id="profileSection">
                <div class="profile-header">
                    <div class="profile-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="profile-info">
                        <h3 id="profileEmail"></h3>
                        <p>بازیکن معدن‌چی طلا</p>
                    </div>
                </div>
                
                <div class="profile-stats">
                    <div class="profile-stat">
                        <div class="profile-stat-value" id="profileBalance">0</div>
                        <div class="profile-stat-label">موجودی طلا</div>
                    </div>
                    <div class="profile-stat usdt">
                        <div class="profile-stat-value" id="profileUSDT">0</div>
                        <div class="profile-stat-label">موجودی تتر</div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-value" id="profileLevel">0</div>
                        <div class="profile-stat-label">سطح</div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-value" id="profileMined">0</div>
                        <div class="profile-stat-label">استخراج شده</div>
                    </div>
                </div>

                <!-- اطلاعات VIP در پروفایل -->
                <div class="vip-progress-container" style="margin-top: 20px; display: none;" id="profileVIPInfo">
                    <div class="vip-progress-header">
                        <div>وضعیت VIP</div>
                        <div class="vip-plan-badge" id="profileVIPBadge">طلایی</div>
                    </div>
                    <div class="vip-progress-bar">
                        <div class="vip-progress-fill" id="profileVIPProgress"></div>
                    </div>
                    <div class="vip-progress-stats">
                        <span id="profileVIPProgressText">0%</span>
                        <span id="profileVIPCap">سقف: ۳,۰۰۰,۰۰۰</span>
                    </div>
                </div>
                
                <div class="profile-actions">
                    <button class="profile-btn btn-logout" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> خروج
                    </button>
                    
                    <!-- دکمه ادمین (فقط برای کاربران ادمین) -->
                    <button class="profile-btn btn-admin" id="adminBtn" style="display: none;" onclick="showAdminPanel()">
                        <i class="fas fa-user-shield"></i> پنل مدیریت
                    </button>
                </div>
            </section>
            
            <!-- بخش استخراج -->
            <section class="hammers-section" id="hammersSection">
                <div class="login-message" id="guestMessage">
                    <p>برای استفاده از ابزارهای استخراج باید وارد حساب کاربری خود شوید</p>
                    <button class="login-btn" onclick="showAuthPage()">
                        <i class="fas fa-sign-in-alt"></i> ورود / ثبت نام
                    </button>
                </div>
                
                <div class="hammers-grid" id="hammersContainer">
                    <!-- چکش توسط جاوااسکریپت اضافه خواهد شد -->
                </div>
            </section>
            
            <!-- بخش سیستم ارجاع - کاملاً بازسازی شده -->
            <section class="referral-section" id="referralSection">
                <div class="referral-hero">
                    <h2><i class="fas fa-users"></i> دوستانت رو دعوت کن</h2>
                    <p>هر دعوت = ۵,۰۰۰ سکه برای تو + ۱۰,۰۰۰ سکه برای دوستت</p>
                </div>
                
                <div class="your-code">
                    <h4>کد تو:</h4>
                    <div class="code-box">
                        <span id="myReferralCode">در حال بارگذاری...</span>
                        <button onclick="copyReferralCode()">📋 کپی</button>
                    </div>
                </div>
                
                <div class="your-earnings">
                    <h4>تا الان از دعوت دوستان:</h4>
                    <div class="earnings-box">
                        <span id="myReferralEarnings">0</span> سکه
                    </div>
                </div>
                
                <div class="invite-buttons">
                    <button onclick="shareViaWhatsApp()">
                        <i class="fab fa-whatsapp"></i> واتساپ
                    </button>
                    <button onclick="shareViaTelegram()">
                        <i class="fab fa-telegram"></i> تلگرام
                    </button>
                    <button onclick="copyInviteLink()">
                        <i class="fas fa-link"></i> کپی لینک
                    </button>
                </div>
                
                <div class="referral-info">
                    <h4>چگونه کار می‌کند؟</h4>
                    <div class="info-steps">
                        <div class="info-step">
                            <span class="step-number">۱</span>
                            <div class="step-text">کد بالا را برای دوستانت بفرست</div>
                        </div>
                        <div class="info-step">
                            <span class="step-number">۲</span>
                            <div class="step-text">دوستانت با کد تو ثبت‌نام کنند</div>
                        </div>
                        <div class="info-step">
                            <span class="step-number">۳</span>
                            <div class="step-text">دوستت <strong>۱۰,۰۰۰ سکه</strong> هدیه می‌گیرد</div>
                        </div>
                        <div class="info-step">
                            <span class="step-number">۴</span>
                            <div class="step-text">تو <strong>۵,۰۰۰ سکه</strong> پاداش می‌گیری</div>
                        </div>
                    </div>
                </div>
                
                <div class="referral-list">
                    <h4>دوستانی که دعوت کردی</h4>
                    <div class="referral-list-container" id="referralsList">
                        <!-- لیست دوستان اینجا نمایش داده می‌شود -->
                        <div class="referral-item">
                            <span class="referral-email">در حال بارگذاری...</span>
                            <span class="referral-reward">-</span>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- بخش سطح‌ها -->
            <section class="levels-section" id="levelsSection">
                <div class="levels-header">
                    <h2 class="levels-title">سیستم سطح‌بندی</h2>
                    <p class="levels-subtitle">سطح خود را ارتقا دهید و پاداش‌های بیشتر دریافت کنید</p>
                </div>
                
                <div class="current-level-info">
                    <div class="current-level-text">سطح فعلی شما</div>
                    <div class="current-level-value" id="currentLevelDisplay">0</div>
                    <div class="level-progress">
                        <div class="progress-text">پیشرفت به سطح بعدی</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="levelProgressFill"></div>
                        </div>
                        <div class="progress-text" id="levelProgressText">0/10000 طلا</div>
                    </div>
                </div>
                
                <div class="levels-grid" id="levelsGrid">
                    <!-- سطح‌ها توسط JavaScript ساخته می‌شوند -->
                </div>
            </section>
        </div>
        
        <!-- تأیید چند مرحله‌ای -->
        <div class="confirmation-grid" id="confirmationGrid">
            <div class="verification-container">
                <div class="verification-header">
                    <div class="verification-icon">
                        <i class="fas fa-shield-check"></i>
                    </div>
                    <div class="verification-title">تأیید امنیتی</div>
                    <div class="verification-subtitle">در حال تأیید تراکنش شما</div>
                </div>
                
                <div class="hash-display" id="hashDisplay">
                    <!-- متن هش اینجا نمایش داده می‌شود -->
                </div>
                
                <div class="verification-steps">
                    <div class="step" id="step1">
                        <div class="step-circle">
                            <i class="fas fa-lock"></i>
                        </div>
                        <div class="step-label">رمزنگاری</div>
                    </div>
                    <div class="step" id="step2">
                        <div class="step-circle">
                            <i class="fas fa-network-wired"></i>
                        </div>
                        <div class="step-label">شبکه</div>
                    </div>
                    <div class="step" id="step3">
                        <div class="step-circle">
                            <i class="fas fa-check-double"></i>
                        </div>
                        <div class="step-label">تأیید نهایی</div>
                    </div>
                </div>
                
                <div class="verification-timer" id="verificationTimer">8</div>
                <div class="verification-reward" id="verificationReward">+10000 GOLD</div>
                
                <button class="verification-btn" id="verificationBtn" onclick="completeVerification()" disabled>
                    در حال تأیید...
                </button>
            </div>
        </div>
        
        <!-- نویگیشن پایین -->
        <nav class="bottom-nav">
            <div class="nav-item active" onclick="showSection('hammers')">
                <i class="fas fa-hammer"></i>
                <span>استخراج</span>
            </div>
            <div class="nav-item" onclick="showSection('conversion')">
                <i class="fas fa-exchange-alt"></i>
                <span>تبدیل ارز</span>
            </div>
            <div class="nav-item" onclick="showSection('vip')">
                <i class="fas fa-crown"></i>
                <span>VIP</span>
            </div>
            <div class="nav-item" onclick="showSection('levels')">
                <i class="fas fa-chart-line"></i>
                <span>سطح</span>
            </div>
            <div class="nav-item" onclick="showSection('referral')">
                <i class="fas fa-user-friends"></i>
                <span>زیرمجموعه</span>
            </div>
            <div class="nav-item" onclick="showSection('profile')">
                <i class="fas fa-user"></i>
                <span>پروفایل</span>
            </div>
        </nav>
    </div>

    <script>
        // ==================== تنظیمات Supabase ====================
        const SUPABASE_URL = 'https://plqdzjvrmssqddmgowbn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBscWR6anZybXNzcWRkbWdvd2JuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNTI2NDUsImV4cCI6MjA3OTkyODY0NX0.PnfyxjvZYyEXOkEVWBR6jOhLJ_tu1aUwQIvFwhcZoDA';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ==================== تنظیمات تبدیل ارز ====================
        const CONVERSION_RATE = 0.00001;
        
        // ==================== سیستم نوتیفیکیشن ====================
        function showNotification(title, message, type = 'info', duration = 5000) {
            const container = document.getElementById('notificationContainer');
            const id = 'notification-' + Date.now();
            
            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.id = id;
            
            notification.innerHTML = `
                <div class="notification-icon">
                    <i class="${icons[type]}"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                </div>
                <button class="notification-close" onclick="closeNotification('${id}')">
                    <i class="fas fa-times"></i>
                </button>
                <div class="notification-progress">
                    <div class="notification-progress-bar" style="animation: progressShrink ${duration}ms linear forwards;"></div>
                </div>
            `;
            
            container.appendChild(notification);
            
            if (duration > 0) {
                setTimeout(() => {
                    closeNotification(id);
                }, duration);
            }
            
            return id;
        }
        
        function closeNotification(id) {
            const notification = document.getElementById(id);
            if (notification) {
                notification.style.animation = 'notificationSlideOut 0.3s ease forwards';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }
        }
        
        // ==================== سیستم اصلی ====================
        let currentUser = null;
        let gameState = {
            rockBalance: 0,
            usdtBalance: 0,
            activeTimers: 0,
            pendingReward: 0,
            verificationTime: 8,
            currentStep: 0,
            verificationInterval: null,
            hashInterval: null,
            vipSettings: null,
            vipCycleInterval: null,
            hammers: [
                {
                    id: 1,
                    name: 'چکش طلایی',
                    icon: 'fas fa-hammer',
                    duration: 30,
                    cooldown: 5,
                    reward: 10000,
                    isActive: false,
                    isOnCooldown: false,
                    timeLeft: 0,
                    progress: 0
                }
            ]
        };

        // ==================== سیستم VIP ====================
        let selectedVIPPlan = null;
        let vipTimerInterval = null;
        // ==================== متغیرهای جدید برای تایمر ریست کاربر ====================
let userResetTimerInterval = null;
let userResetTimeLeft = 0;
let isUserResetTimerActive = false;

        // بارگذاری تنظیمات VIP
        async function loadVIPSettings() {
            try {
                const { data, error } = await supabase
                    .from('vip_settings')
                    .select('*')
                    .single();
                
                if (error) {
                    console.error('خطا در بارگذاری تنظیمات VIP:', error);
                    return null;
                }
                
                gameState.vipSettings = data;
                
                // آپدیت نمایش قیمت‌ها
                document.getElementById('goldPlanPrice').textContent = `${data.gold_price} USDT`;
                document.getElementById('diamondPlanPrice').textContent = `${data.diamond_price} USDT`;
                
                // آپدیت نمایش سقف‌ها
                document.getElementById('goldPlanCap').textContent = `سقف: ${data.gold_plan_cap.toLocaleString()} سکه`;
                document.getElementById('diamondPlanCap').textContent = `سقف: ${data.diamond_plan_cap.toLocaleString()} سکه`;
                
                // نمایش آدرس کیف پول
                document.getElementById('paymentWallet').textContent = data.bsc_wallet_address;
                
                return data;
            } catch (error) {
                console.error('خطا در بارگذاری تنظیمات VIP:', error);
                return null;
            }
        }

        // ==================== بررسی محدودیت کاربر ====================
async function checkUserLimit() {
    if (!currentUser) return true;
    
    // اگر کاربر VIP فعال دارد
    if (currentUser.vip_status === 'active' && currentUser.vip_plan) {
        const vipSettings = await loadVIPSettings();
        if (!vipSettings) return true;
        
        const cycleMined = currentUser.current_cycle_mined || 0;
        const userCap = currentUser.vip_plan === 'gold' 
            ? vipSettings.gold_plan_cap 
            : vipSettings.diamond_plan_cap;
        
        if (cycleMined >= userCap) {
            // چک کن اگر تایمر ریست فعال است
            await checkActiveResetTimers();
            
            // اگر تایمر فعال نیست، شروع کن
            if (!isUserResetTimerActive) {
                await startUserVIPResetTimer();
            }
            
            return false;
        }
        
        return true;
    }
    
    // کاربر عادی
    const totalMined = currentUser.total_mined_all_time || 0;
    const normalCap = gameState.vipSettings?.normal_user_cap || 3000000;
    
    if (totalMined >= normalCap) {
        document.getElementById('limitModal').style.display = 'flex';
        return false;
    }
    
    return true;
}

        // بررسی و ریست سیکل VIP
        async function checkAndResetVIPCycle() {
            try {
                const { data, error } = await supabase.rpc('check_and_reset_vip_cycle');
                
                if (error) {
                    console.error('خطا در بررسی سیکل VIP:', error);
                    return;
                }
                
                if (data) {
                    console.log('سیکل VIP ریست شد');
                    // تازه‌سازی اطلاعات کاربر
                    if (currentUser && currentUser.vip_status === 'active') {
                        await loadUserVIPStatus();
                    }
                }
            } catch (error) {
                console.error('خطا در بررسی سیکل VIP:', error);
            }
        }

        // بارگذاری وضعیت VIP کاربر
        async function loadUserVIPStatus() {
            if (!currentUser) return;
            
            try {
                const { data: user, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                
                if (error) throw error;
                
                currentUser = user;
                updateVIPDisplay();
                
                // اگر VIP فعال است، تایمر را شروع کن
                if (user.vip_status === 'active' && user.vip_plan) {
                    startVIPTimer();
                }
            } catch (error) {
                console.error('خطا در بارگذاری وضعیت VIP:', error);
            }
        }

        // ==================== آپدیت نمایش VIP ====================
function updateVIPDisplay() {
    console.log('🔄 updateVIPDisplay called for:', currentUser?.email);
    console.log('User VIP status:', currentUser?.vip_status);
    console.log('User VIP plan:', currentUser?.vip_plan);
    
    if (!currentUser) {
        console.log('❌ No current user!');
        return;
    }
    
    const vipStatBadge = document.getElementById('vipStatBadge');
    const normalUserStatus = document.getElementById('normalUserStatus');
    const vipUserStatus = document.getElementById('vipUserStatus');
    const pendingVIPStatus = document.getElementById('pendingVIPStatus');
    const vipTimerContainer = document.getElementById('vipTimerContainer');
    const vipProgressContainer = document.getElementById('vipProgressContainer');
    const profileVIPInfo = document.getElementById('profileVIPInfo');
    const userResetTimerContainer = document.getElementById('userResetTimerContainer');
    
    // مخفی کردن همه بخش‌ها
    if (vipStatBadge) vipStatBadge.style.display = 'none';
    if (normalUserStatus) normalUserStatus.style.display = 'none';
    if (vipUserStatus) vipUserStatus.style.display = 'none';
    if (pendingVIPStatus) pendingVIPStatus.style.display = 'none';
    if (vipTimerContainer) vipTimerContainer.style.display = 'none';
    if (vipProgressContainer) vipProgressContainer.style.display = 'none';
    if (profileVIPInfo) profileVIPInfo.style.display = 'none';
    if (userResetTimerContainer) userResetTimerContainer.style.display = 'none';
    
    // ریست دکمه‌های خرید پلن
    const goldPlanBtn = document.getElementById('goldPlanBtn');
    const diamondPlanBtn = document.getElementById('diamondPlanBtn');
    
    if (goldPlanBtn) {
        goldPlanBtn.disabled = false;
        goldPlanBtn.innerHTML = '<i class="fas fa-shopping-cart"></i> خرید پلن طلایی';
        goldPlanBtn.setAttribute('onclick', "selectVIPPlan('gold')");
    }
    
    if (diamondPlanBtn) {
        diamondPlanBtn.disabled = false;
        diamondPlanBtn.innerHTML = '<i class="fas fa-shopping-cart"></i> خرید پلن الماس';
        diamondPlanBtn.setAttribute('onclick', "selectVIPPlan('diamond')");
    }
    
    // نمایش وضعیت مناسب برای کاربر CURRENT
    console.log('Current VIP status:', currentUser.vip_status);
    
    switch (currentUser.vip_status) {
        case 'active':
            if (currentUser.vip_plan) {
                console.log('✅ User has active VIP plan:', currentUser.vip_plan);
                
                // نمایش VIP
                if (vipStatBadge) vipStatBadge.style.display = 'flex';
                if (vipUserStatus) vipUserStatus.style.display = 'block';
                if (vipTimerContainer) vipTimerContainer.style.display = 'block';
                if (vipProgressContainer) vipProgressContainer.style.display = 'block';
                if (profileVIPInfo) profileVIPInfo.style.display = 'block';
                
                // تنظیم متن و رنگ
                const planName = currentUser.vip_plan === 'gold' ? 'طلایی' : 'الماس';
                if (document.getElementById('vipPlanName')) {
                    document.getElementById('vipPlanName').textContent = planName;
                }
                if (document.getElementById('currentVIPPlanName')) {
                    document.getElementById('currentVIPPlanName').textContent = planName;
                }
                
                // آپدیت بدج پروفایل
                const badgeClass = currentUser.vip_plan === 'gold' ? 'badge-gold' : 'badge-diamond';
                if (document.getElementById('vipPlanBadge')) {
                    document.getElementById('vipPlanBadge').className = `vip-plan-badge ${badgeClass}`;
                    document.getElementById('vipPlanBadge').textContent = planName;
                }
                
                // تنظیم دکمه‌ها برای کاربر VIP فعال
                if (goldPlanBtn && diamondPlanBtn) {
                    if (currentUser.vip_plan === 'gold') {
                        // کاربر پلن طلایی داره - می‌تونه الماس بخرد
                        goldPlanBtn.disabled = true;
                        goldPlanBtn.innerHTML = '<i class="fas fa-check"></i> فعال (طلایی)';
                        
                        diamondPlanBtn.disabled = false;
                        diamondPlanBtn.innerHTML = '<i class="fas fa-shopping-cart"></i> خرید پلن الماس';
                        diamondPlanBtn.setAttribute('onclick', "selectVIPPlan('diamond')");
                        
                    } else if (currentUser.vip_plan === 'diamond') {
                        // کاربر پلن الماس داره - همه دکمه‌ها غیرفعال
                        goldPlanBtn.disabled = true;
                        goldPlanBtn.innerHTML = '<i class="fas fa-check"></i> فعال';
                        
                        diamondPlanBtn.disabled = true;
                        diamondPlanBtn.innerHTML = '<i class="fas fa-crown"></i> حداکثر پلن';
                        diamondPlanBtn.removeAttribute('onclick');
                    }
                }
                
                // آپدیت نمودار پیشرفت
                updateVIPProgress();
                
                // بررسی تایمر ریست
                checkActiveResetTimers();
                
            }
            break;
            
        case 'pending':
            console.log('⏳ User has pending VIP request');
            if (pendingVIPStatus) pendingVIPStatus.style.display = 'block';
            
            // غیرفعال کردن همه دکمه‌ها در حالت انتظار
            if (goldPlanBtn) {
                goldPlanBtn.disabled = true;
                goldPlanBtn.innerHTML = '<i class="fas fa-clock"></i> در انتظار تایید';
            }
            if (diamondPlanBtn) {
                diamondPlanBtn.disabled = true;
                diamondPlanBtn.innerHTML = '<i class="fas fa-clock"></i> در انتظار تایید';
            }
            break;
            
        case 'inactive':
        default:
            console.log('👤 User is normal (no VIP)');
            if (normalUserStatus) normalUserStatus.style.display = 'block';
            const totalMined = currentUser.total_mined_all_time || 0;
            const normalCap = gameState.vipSettings?.normal_user_cap || 3000000;
            const remaining = normalCap - totalMined;
            
            if (document.getElementById('normalUserProgress')) {
                document.getElementById('normalUserProgress').textContent = 
                    `${totalMined.toLocaleString()} از ${normalCap.toLocaleString()} سکه استخراج شده`;
            }
            
            // دکمه‌ها فعال برای خرید اولیه
            if (goldPlanBtn) {
                goldPlanBtn.disabled = false;
                goldPlanBtn.setAttribute('onclick', "selectVIPPlan('gold')");
            }
            if (diamondPlanBtn) {
                diamondPlanBtn.disabled = false;
                diamondPlanBtn.setAttribute('onclick', "selectVIPPlan('diamond')");
            }
            
            // اگر نزدیک به سقف است، هشدار بده
            if (totalMined >= normalCap * 0.8) {
                const remainingPercent = Math.round((remaining / normalCap) * 100);
                showNotification('نزدیک به سقف', `${remainingPercent}% تا رسیدن به سقف کاربر عادی`, 'warning');
            }
            break;
    }
    
    // آپدیت اطلاعات کوه برای کاربر عادی
    if (currentUser.vip_status === 'inactive' || !currentUser.vip_status) {
        const totalMined = currentUser.total_mined_all_time || 0;
        const normalCap = gameState.vipSettings?.normal_user_cap || 3000000;
        const progressPercent = Math.min((totalMined / normalCap) * 100, 100);
        
        // آپدیت نمایش کوه
        if (document.getElementById('mountainGold')) {
            document.getElementById('mountainGold').style.transform = 
                `perspective(1000px) rotateX(10deg) scaleY(${progressPercent / 100})`;
        }
    }
    
    console.log('🔄 VIP display updated successfully');
}

// ==================== آپدیت نمودار پیشرفت VIP ====================
function updateVIPProgress() {
    if (!currentUser || !currentUser.vip_plan || currentUser.vip_status !== 'active') return;
    
    if (!gameState.vipSettings) return;
    
    const cycleMined = currentUser.current_cycle_mined || 0;
    const userCap = currentUser.vip_plan === 'gold' 
        ? gameState.vipSettings.gold_plan_cap 
        : gameState.vipSettings.diamond_plan_cap;
    
    const progressPercent = Math.min((cycleMined / userCap) * 100, 100);
    const remaining = userCap - cycleMined;
    
    // آپدیت نمودار
    const progressFill = document.getElementById('vipProgressFill');
    if (progressFill) {
        progressFill.style.width = `${progressPercent}%`;
        progressFill.className = currentUser.vip_plan === 'gold' 
            ? 'vip-progress-fill progress-gold' 
            : 'vip-progress-fill progress-diamond';
    }
    
    // آپدیت متن‌ها
    if (document.getElementById('vipProgressText')) {
        document.getElementById('vipProgressText').textContent = `${Math.round(progressPercent)}%`;
    }
    if (document.getElementById('vipCapRemaining')) {
        document.getElementById('vipCapRemaining').textContent = `${remaining.toLocaleString()} سکه باقی‌مانده`;
    }
    if (document.getElementById('currentCycleMined')) {
        document.getElementById('currentCycleMined').textContent = cycleMined.toLocaleString();
    }
    if (document.getElementById('cycleCap')) {
        document.getElementById('cycleCap').textContent = userCap.toLocaleString();
    }
    
    // آپدیت پروفایل
    const profileProgress = document.getElementById('profileVIPProgress');
    if (profileProgress) {
        profileProgress.style.width = `${progressPercent}%`;
        profileProgress.className = currentUser.vip_plan === 'gold' 
            ? 'vip-progress-fill progress-gold' 
            : 'vip-progress-fill progress-diamond';
    }
    
    if (document.getElementById('profileVIPProgressText')) {
        document.getElementById('profileVIPProgressText').textContent = `${Math.round(progressPercent)}%`;
    }
    if (document.getElementById('profileVIPCap')) {
        document.getElementById('profileVIPCap').textContent = `سقف: ${userCap.toLocaleString()}`;
    }
    if (document.getElementById('profileVIPBadge')) {
        document.getElementById('profileVIPBadge').textContent = currentUser.vip_plan === 'gold' ? 'طلایی' : 'الماس';
        document.getElementById('profileVIPBadge').className = `vip-plan-badge ${currentUser.vip_plan === 'gold' ? 'badge-gold' : 'badge-diamond'}`;
    }
}

// ==================== آپدیت نمایش تایمر VIP ====================
function updateVIPTimerDisplay() {
    if (!gameState.vipSettings || !gameState.vipSettings.current_cycle_end) return;
    
    const cycleEnd = new Date(gameState.vipSettings.current_cycle_end);
    const now = new Date();
    const diffMs = cycleEnd - now;
    
    if (diffMs <= 0) {
        if (document.getElementById('vipTimerDisplay')) {
            document.getElementById('vipTimerDisplay').textContent = '00:00';
        }
        return;
    }
    
    const diffSec = Math.floor(diffMs / 1000);
    const minutes = Math.floor(diffSec / 60);
    const seconds = diffSec % 60;
    
    if (document.getElementById('vipTimerDisplay')) {
        document.getElementById('vipTimerDisplay').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
}

// ==================== شروع تایمر VIP ====================
function startVIPTimer() {
    if (vipTimerInterval) clearInterval(vipTimerInterval);
    
    vipTimerInterval = setInterval(async () => {
        // بررسی ریست سیکل
        await checkAndResetVIPCycle();
        
        // آپدیت نمایش تایمر
        updateVIPTimerDisplay();
        
        // آپدیت پیشرفت
        updateVIPProgress();
    }, 1000);
    
    updateVIPTimerDisplay();
}

// چک کردن وضعیت VIP کاربر از دیتابیس
async function checkUserVIPStatus() {
    if (!currentUser) return;
    
    try {
        console.log('🔍 Checking VIP status from DB...');
        
        const { data: user, error } = await supabase
            .from('users')
            .select('vip_status, vip_plan, payment_txid, vip_purchased_at')
            .eq('id', currentUser.id)
            .single();
        
        if (error) {
            console.error('Error checking VIP status:', error);
            return;
        }
        
        console.log('📊 DB VIP status:', user);
        
        // آپدیت کاربر محلی
        currentUser.vip_status = user.vip_status;
        currentUser.vip_plan = user.vip_plan;
        currentUser.payment_txid = user.payment_txid;
        currentUser.vip_purchased_at = user.vip_purchased_at;
        
        // آپدیت نمایش
        updateVIPDisplay();
        
    } catch (error) {
        console.error('Error in checkUserVIPStatus:', error);
    }
}

// این تابع رو هر 30 ثانیه صدا بزن
setInterval(checkUserVIPStatus, 30000);
        
        // ==================== شروع تایمر ریست برای کاربر ====================
async function startUserVIPResetTimer() {
    if (!currentUser || currentUser.vip_status !== 'active') return;
    
    // اگر از قبل تایمر فعال است، خروج
    if (isUserResetTimerActive) return;
    
    try {
        // زمان‌های شروع و پایان
        const resetStart = new Date();
        const resetEnd = new Date(resetStart.getTime() + 60000);
        
        // ذخیره در دیتابیس
        const { error } = await supabase
            .from('user_vip_reset_timers')
            .insert({
                user_id: currentUser.id,
                reset_start_time: resetStart.toISOString(),
                reset_end_time: resetEnd.toISOString(),
                is_active: true
            });
        
        if (error) {
            console.error('خطا در ثبت تایمر ریست:', error);
            return;
        }
        
        // شروع تایمر محلی
        isUserResetTimerActive = true;
        userResetTimeLeft = 5 * 60; // 5 دقیقه بر حسب ثانیه
        
        // نمایش تایمر
        document.getElementById('userResetTimerContainer').style.display = 'block';
        updateUserResetTimerDisplay();
        
        // توقف تایمر قبلی اگر وجود دارد
        if (userResetTimerInterval) clearInterval(userResetTimerInterval);
        
        // شروع تایمر جدید
        userResetTimerInterval = setInterval(async () => {
            userResetTimeLeft--;
            updateUserResetTimerDisplay();
            
            if (userResetTimeLeft <= 0) {
                clearInterval(userResetTimerInterval);
                await completeUserVIPReset();
            }
        }, 1000);
        
        showNotification('تایمر ریست شروع شد', 'بعد از اتمام تایمر سقف استخراج شما ریست می‌شود.', 'info');
        
    } catch (error) {
        console.error('خطا در شروع تایمر ریست:', error);
        showNotification('خطا', 'خطا در شروع تایمر ریست', 'error');
    }
}

// ==================== تکمیل ریست سیکل کاربر ====================
async function completeUserVIPReset() {
    try {
        // آپدیت کاربر در دیتابیس
        const { error: updateError } = await supabase
            .from('users')
            .update({
                current_cycle_mined: 0,
                updated_at: new Date().toISOString()
            })
            .eq('id', currentUser.id)
            .eq('vip_status', 'active');
        
        if (updateError) throw updateError;
        
        // غیرفعال کردن تایمر در دیتابیس
        const { error: timerError } = await supabase
            .from('user_vip_reset_timers')
            .update({
                is_active: false,
                updated_at: new Date().toISOString()
            })
            .eq('user_id', currentUser.id)
            .eq('is_active', true);
        
        if (timerError) throw timerError;
        
        // آپدیت وضعیت محلی
        currentUser.current_cycle_mined = 0;
        isUserResetTimerActive = false;
        
        // مخفی کردن تایمر
        document.getElementById('userResetTimerContainer').style.display = 'none';
        
        // آپدیت نمایش
        updateVIPCycleInfo();
        
        showNotification('سقف ریست شد!', 'حالا می‌توانید دوباره استخراج کنید.', 'success');
        
    } catch (error) {
        console.error('خطا در ریست سیکل:', error);
        showNotification('سقف ریست شد!', 'حالا می‌توانید دوباره استخراج کنید.', 'success')
    }
}

async function refreshUserData() {
    if (!currentUser) return;
    
    try {
        console.log('🔄 در حال دریافت داده‌های تازه کاربر...');
        
        const { data: freshUser, error } = await supabase
            .from('users')
            .select('*')
            .eq('id', currentUser.id)
            .single();
        
        if (error) {
            console.error('❌ خطا در دریافت داده‌های کاربر:', error);
            return;
        }
        
        // آپدیت کاربر محلی
        currentUser = freshUser;
        console.log('✅ داده‌های کاربر آپدیت شد:', {
            current_cycle_mined: currentUser.current_cycle_mined,
            balance: currentUser.balance
        });
        
        // آپدیت gameState
        gameState.rockBalance = currentUser.balance || 0;
        gameState.usdtBalance = currentUser.usdt_balance || 0;
        
        // آپدیت UI
        updateUI();
        updateProfile();
        
    } catch (error) {
        console.error('❌ خطا در refreshUserData:', error);
    }
}

// ==================== آپدیت نمایش تایمر ریست ====================
function updateUserResetTimerDisplay() {
    const minutes = Math.floor(userResetTimeLeft / 60);
    const seconds = userResetTimeLeft % 60;
    
    document.getElementById('userResetTimerDisplay').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    // آپدیت نوار پیشرفت
    const totalTime = 60;
    const progressPercent = ((totalTime - userResetTimeLeft) / totalTime) * 100;
    document.getElementById('userResetProgressFill').style.width = `${progressPercent}%`;
    
    // آپدیت متن اطلاعات
    document.getElementById('userResetInfo').innerHTML = 
        `${minutes} دقیقه و ${seconds} ثانیه تا ریست سقف`;
}

// ==================== چک کردن تایمرهای فعال ====================
async function checkActiveResetTimers() {
    if (!currentUser || currentUser.vip_status !== 'active') return;
    
    try {
        // چک کردن تایمرهای فعال برای کاربر
        const { data: activeTimers, error } = await supabase
            .from('user_vip_reset_timers')
            .select('*')
            .eq('user_id', currentUser.id)
            .eq('is_active', true)
            .order('created_at', { ascending: false })
            .limit(1);
        
        if (error) throw error;
        
        if (activeTimers && activeTimers.length > 0) {
            const timer = activeTimers[0];
            const resetEnd = new Date(timer.reset_end_time);
            const now = new Date();
            
            if (now >= resetEnd) {
                // زمان تایمر گذشته، ریست کن
                await completeUserVIPReset();
            } else {
                // تایمر هنوز فعال است، ادامه بده
                const timeLeftMs = resetEnd - now;
                userResetTimeLeft = Math.floor(timeLeftMs / 1000);
                isUserResetTimerActive = true;
                
                // نمایش و شروع تایمر
                document.getElementById('userResetTimerContainer').style.display = 'block';
                updateUserResetTimerDisplay();
                
                if (userResetTimerInterval) clearInterval(userResetTimerInterval);
                
                userResetTimerInterval = setInterval(async () => {
                    userResetTimeLeft--;
                    updateUserResetTimerDisplay();
                    
                    if (userResetTimeLeft <= 0) {
                        clearInterval(userResetTimerInterval);
                        await completeUserVIPReset();
                    }
                }, 1000);
            }
        }
        
    } catch (error) {
        console.error('خطا در چک کردن تایمرها:', error);
    }
}

        // آپدیت نمودار پیشرفت VIP
        function updateVIPProgress() {
            if (!currentUser || !currentUser.vip_plan || currentUser.vip_status !== 'active') return;
            
            if (!gameState.vipSettings) return;
            
            const cycleMined = currentUser.current_cycle_mined || 0;
            const userCap = currentUser.vip_plan === 'gold' 
                ? gameState.vipSettings.gold_plan_cap 
                : gameState.vipSettings.diamond_plan_cap;
            
            const progressPercent = Math.min((cycleMined / userCap) * 100, 100);
            const remaining = userCap - cycleMined;
            
            // آپدیت نمودار
            const progressFill = document.getElementById('vipProgressFill');
            progressFill.style.width = `${progressPercent}%`;
            progressFill.className = currentUser.vip_plan === 'gold' 
                ? 'vip-progress-fill progress-gold' 
                : 'vip-progress-fill progress-diamond';
            
            // آپدیت متن‌ها
            document.getElementById('vipProgressText').textContent = `${Math.round(progressPercent)}%`;
            document.getElementById('vipCapRemaining').textContent = `${remaining.toLocaleString()} سکه باقی‌مانده`;
            document.getElementById('currentCycleMined').textContent = cycleMined.toLocaleString();
            document.getElementById('cycleCap').textContent = userCap.toLocaleString();
            
            // آپدیت پروفایل
            const profileProgress = document.getElementById('profileVIPProgress');
            profileProgress.style.width = `${progressPercent}%`;
            profileProgress.className = currentUser.vip_plan === 'gold' 
                ? 'vip-progress-fill progress-gold' 
                : 'vip-progress-fill progress-diamond';
            
            document.getElementById('profileVIPProgressText').textContent = `${Math.round(progressPercent)}%`;
            document.getElementById('profileVIPCap').textContent = `سقف: ${userCap.toLocaleString()}`;
            document.getElementById('profileVIPBadge').textContent = currentUser.vip_plan === 'gold' ? 'طلایی' : 'الماس';
            document.getElementById('profileVIPBadge').className = `vip-plan-badge ${currentUser.vip_plan === 'gold' ? 'badge-gold' : 'badge-diamond'}`;
        }

        // شروع تایمر VIP
        function startVIPTimer() {
            if (vipTimerInterval) clearInterval(vipTimerInterval);
            
            vipTimerInterval = setInterval(async () => {
                // بررسی ریست سیکل
                await checkAndResetVIPCycle();
                
                // آپدیت نمایش تایمر
                updateVIPTimerDisplay();
                
                // آپدیت پیشرفت
                updateVIPProgress();
            }, 1000);
            
            updateVIPTimerDisplay();
        }

        // آپدیت نمایش تایمر VIP
        function updateVIPTimerDisplay() {
            if (!gameState.vipSettings || !gameState.vipSettings.current_cycle_end) return;
            
            const cycleEnd = new Date(gameState.vipSettings.current_cycle_end);
            const now = new Date();
            const diffMs = cycleEnd - now;
            
            if (diffMs <= 0) {
                document.getElementById('vipTimerDisplay').textContent = '00:00';
                return;
            }
            
            const diffSec = Math.floor(diffMs / 1000);
            const minutes = Math.floor(diffSec / 60);
            const seconds = diffSec % 60;
            
            document.getElementById('vipTimerDisplay').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // ==================== انتخاب پلن VIP (ساده‌شده) ====================
function selectVIPPlan(planType) {
    console.log('انتخاب پلن:', planType);
    
    if (!currentUser) {
        showAuthPage();
        return;
    }
    
    // اگر کاربر VIP فعال دارد و همان پلن را انتخاب کرده
    if (currentUser.vip_status === 'active' && currentUser.vip_plan === planType) {
        showNotification('پلن فعال', `شما در حال حاضر پلن ${planType === 'gold' ? 'طلایی' : 'الماس'} دارید!`, 'info');
        return;
    }
    
    // انتخاب پلن
    selectedVIPPlan = planType;
    
    // نمایش صفحه پرداخت
    document.getElementById('vipPlansGrid').style.display = 'none';
    document.getElementById('vipPaymentContainer').style.display = 'block';
    
    // نمایش مبلغ کامل (نه مابه‌تفاوت)
    const price = planType === 'gold' 
        ? (gameState.vipSettings?.gold_price || 10)
        : (gameState.vipSettings?.diamond_price || 20);
    
    const planName = planType === 'gold' ? 'طلایی' : 'الماس';
    
    // آپدیت اطلاعات صفحه پرداخت
    document.getElementById('paymentWallet').innerHTML = `
        <div style="margin-bottom: 10px;">مبلغ: <strong style="color: var(--gold); font-size: 1.2em;">${price} USDT</strong></div>
        <div>آدرس کیف پول BEP20:</div>
        <div style="word-break: break-all; margin-top: 5px; font-family: monospace; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px;">
            ${gameState.vipSettings?.bsc_wallet_address || 'در حال بارگذاری...'}
        </div>
    `;
    
    // آپدیت عنوان
    document.querySelector('#vipPaymentContainer h3').innerHTML = 
        `<i class="fas fa-wallet"></i> خرید پلن ${planName} (${price} USDT)`;
    
    showNotification('پلن انتخاب شد', `پلن ${planName} انتخاب شد. مبلغ: ${price} USDT`, 'info');
}

// ==================== نمایش صفحه پرداخت VIP ====================
function showVIPPayment() {
    if (!selectedVIPPlan) return;
    
    // نمایش بخش پرداخت
    document.getElementById('vipPlansGrid').style.display = 'none';
    document.getElementById('vipPaymentContainer').style.display = 'block';
    
    // آپدیت اطلاعات پرداخت
    const price = selectedVIPPlan === 'gold' 
        ? gameState.vipSettings?.gold_price || 10
        : gameState.vipSettings?.diamond_price || 20;
    
    const planName = selectedVIPPlan === 'gold' ? 'طلایی' : 'الماس';
    
    // تنظیم متن مناسب بر اساس وضعیت کاربر
    let paymentTitle = '';
    if (currentUser.vip_status === 'active' && currentUser.vip_plan === 'gold' && selectedVIPPlan === 'diamond') {
        paymentTitle = 'ارتقاء به پلن الماس';
        const upgradePrice = price - (gameState.vipSettings?.gold_price || 10);
        document.getElementById('paymentWallet').innerHTML = `
            <div style="margin-bottom: 10px;">مبلغ ارتقاء: <strong>${upgradePrice} USDT</strong></div>
            <div>آدرس کیف پول:</div>
            <div style="word-break: break-all; margin-top: 5px;">${gameState.vipSettings?.bsc_wallet_address || 'در حال بارگذاری...'}</div>
        `;
    } else {
        paymentTitle = `خرید پلن ${planName}`;
        document.getElementById('paymentWallet').innerHTML = `
            <div style="margin-bottom: 10px;">مبلغ: <strong>${price} USDT</strong></div>
            <div>آدرس کیف پول:</div>
            <div style="word-break: break-all; margin-top: 5px;">${gameState.vipSettings?.bsc_wallet_address || 'در حال بارگذاری...'}</div>
        `;
    }
    
    document.querySelector('#vipPaymentContainer h3').innerHTML = `<i class="fas fa-wallet"></i> ${paymentTitle} (BEP20)`;
    
    showNotification('پلن انتخاب شد', `پلن ${planName} انتخاب شد. لطفاً پرداخت را تکمیل کنید.`, 'info');
}

        // لغو پرداخت
        function cancelPayment() {
            selectedVIPPlan = null;
            document.getElementById('vipPlansGrid').style.display = 'grid';
            document.getElementById('vipPaymentContainer').style.display = 'none';
            document.getElementById('txidInput').value = '';
        }

       // ==================== ارسال پرداخت ====================
async function submitPayment() {
    console.log('ارسال پرداخت برای پلن:', selectedVIPPlan);
    
    if (!selectedVIPPlan || !currentUser) {
        showNotification('خطا', 'لطفاً اول پلن را انتخاب کنید', 'error');
        return;
    }
    
    const txid = document.getElementById('txidInput').value.trim();
    if (!txid) {
        showNotification('خطا', 'لطفاً TXID تراکنش را وارد کنید', 'error');
        return;
    }
    
    // قیمت کامل
    const price = selectedVIPPlan === 'gold' 
        ? (gameState.vipSettings?.gold_price || 10)
        : (gameState.vipSettings?.diamond_price || 20);
    
    try {
        // ۱. ثبت درخواست VIP
        const { error: userError } = await supabase
            .from('users')
            .update({
                vip_plan: selectedVIPPlan,
                vip_status: 'pending',
                payment_txid: txid,
                vip_purchased_at: new Date().toISOString()
            })
            .eq('id', currentUser.id);
        
        if (userError) throw userError;
        
        // ۲. ثبت در جدول پرداخت‌ها
        const { error: paymentError } = await supabase
            .from('vip_payments')
            .insert({
                user_id: currentUser.id,
                plan_type: selectedVIPPlan,
                amount: price,
                txid: txid,
                status: 'pending'
            });
        
        if (paymentError) throw paymentError;
        
        // ۳. آپدیت کاربر محلی
        currentUser.vip_plan = selectedVIPPlan;
        currentUser.vip_status = 'pending';
        currentUser.payment_txid = txid;
        
        // ۴. نمایش وضعیت
        document.getElementById('paymentStatus').style.display = 'block';
        document.getElementById('statusText').textContent = 'در انتظار تایید ادمین';
        document.getElementById('paymentStatus').className = 'payment-status status-pending';
        
        // ۵. آپدیت نمایش
        updateVIPDisplay();
        
        showNotification('درخواست ارسال شد', 'پرداخت شما برای بررسی ارسال شد.', 'success');
        
        // ۶. ریست فرم
        setTimeout(() => {
            cancelPayment();
        }, 3000);
        
    } catch (error) {
        console.error('خطا در ثبت پرداخت:', error);
        showNotification('خطا', 'خطا در ثبت پرداخت', 'error');
    }
}

        // ==================== سیستم ادمین ====================
        
        // نمایش پنل ادمین
        function showAdminPanel() {
            if (!currentUser || !currentUser.is_admin) {
                showNotification('دسترسی denied', 'شما دسترسی ادمین ندارید!', 'error');
                return;
            }
            
            document.getElementById('adminPanel').style.display = 'flex';
            loadAdminData();
        }

        // بستن پنل ادمین
        function closeAdminPanel() {
            document.getElementById('adminPanel').style.display = 'none';
        }

        // تغییر تب‌های ادمین
        function showAdminTab(tabName) {
            // حذف کلاس active از همه تب‌ها
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.admin-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // اضافه کردن کلاس active به تب انتخاب شده
            document.querySelector(`.admin-tab[onclick="showAdminTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}Tab`).classList.add('active');
        }

        // بارگذاری داده‌های ادمین
        async function loadAdminData() {
            if (!currentUser || !currentUser.is_admin) return;
            
            try {
                // بارگذاری آمار
                await loadAdminStats();
                
                // بارگذاری درخواست‌های در انتظار
                await loadPendingRequests();
                
                // بارگذاری کاربران VIP
                await loadVIPUsers();
                
                // بارگذاری پرداخت‌ها
                await loadPayments();
                
                // بارگذاری همه کاربران
                await loadAllUsers();
                
                showNotification('اطلاعات بروزرسانی شد', 'داده‌های پنل ادمین بروزرسانی شد', 'success');
                
            } catch (error) {
                console.error('خطا در بارگذاری داده‌های ادمین:', error);
                showNotification('خطا', 'خطا در بارگذاری داده‌های ادمین', 'error');
            }
        }

        // بارگذاری آمار ادمین
        async function loadAdminStats() {
            try {
                // تعداد کل کاربران
                const { count: totalUsers, error: usersError } = await supabase
                    .from('users')
                    .select('*', { count: 'exact', head: true });
                
                // تعداد کاربران VIP
                const { count: vipUsers, error: vipError } = await supabase
                    .from('users')
                    .select('*', { count: 'exact', head: true })
                    .eq('vip_status', 'active');
                
                // تعداد درخواست‌های در انتظار
                const { count: pendingRequests, error: pendingError } = await supabase
                    .from('vip_payments')
                    .select('*', { count: 'exact', head: true })
                    .eq('status', 'pending');
                
                // مجموع درآمد از VIP
                const { data: payments, error: paymentsError } = await supabase
                    .from('vip_payments')
                    .select('amount')
                    .eq('status', 'confirmed');
                
                let totalRevenue = 0;
                if (payments) {
                    totalRevenue = payments.reduce((sum, payment) => sum + parseFloat(payment.amount), 0);
                }
                
                // نمایش آمار
                document.getElementById('adminStats').innerHTML = `
                    <div class="admin-stat-card">
                        <div class="admin-stat-value stat-total">${totalUsers || 0}</div>
                        <div class="admin-stat-label">کاربران کل</div>
                    </div>
                    <div class="admin-stat-card">
                        <div class="admin-stat-value stat-vip">${vipUsers || 0}</div>
                        <div class="admin-stat-label">کاربران VIP</div>
                    </div>
                    <div class="admin-stat-card">
                        <div class="admin-stat-value stat-pending">${pendingRequests || 0}</div>
                        <div class="admin-stat-label">در انتظار تایید</div>
                    </div>
                    <div class="admin-stat-card">
                        <div class="admin-stat-value stat-revenue">${totalRevenue.toFixed(2)}</div>
                        <div class="admin-stat-label">درآمد کل (USDT)</div>
                    </div>
                `;
                
            } catch (error) {
                console.error('خطا در بارگذاری آمار:', error);
            }
        }

        // بارگذاری درخواست‌های در انتظار
        async function loadPendingRequests() {
            try {
                const { data: payments, error } = await supabase
                    .from('vip_payments')
                    .select(`
                        *,
                        users (
                            email,
                            vip_plan,
                            vip_status
                        )
                    `)
                    .eq('status', 'pending')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const tableBody = document.getElementById('pendingRequestsTable');
                
                if (!payments || payments.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="no-data">هیچ درخواست در انتظاری وجود ندارد</td>
                        </tr>
                    `;
                    return;
                }
                
                tableBody.innerHTML = '';
                
                payments.forEach(payment => {
                    const user = payment.users;
                    const planName = payment.plan_type === 'gold' ? 'طلایی' : 'الماس';
                    const date = new Date(payment.created_at).toLocaleDateString('fa-IR');
                    
                    tableBody.innerHTML += `
                        <tr>
                            <td>
                                <div class="user-email">${user.email}</div>
                            </td>
                            <td>
                                <span class="user-plan ${payment.plan_type === 'gold' ? 'plan-gold' : 'plan-diamond'}">
                                    ${planName}
                                </span>
                            </td>
                            <td>${payment.amount} USDT</td>
                            <td class="txid-cell">${payment.txid || '-'}</td>
                            <td class="date-cell">${date}</td>
                            <td>
                                <div class="admin-actions">
                                    <button class="action-btn btn-approve" onclick="approveVIPRequest('${payment.id}', '${payment.user_id}')">
                                        <i class="fas fa-check"></i> تایید
                                    </button>
                                    <button class="action-btn btn-reject" onclick="rejectVIPRequest('${payment.id}')">
                                        <i class="fas fa-times"></i> رد
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
            } catch (error) {
                console.error('خطا در بارگذاری درخواست‌ها:', error);
                document.getElementById('pendingRequestsTable').innerHTML = `
                    <tr>
                        <td colspan="6" class="no-data">خطا در بارگذاری داده‌ها</td>
                    </tr>
                `;
            }
        }

        // بارگذاری کاربران VIP
        async function loadVIPUsers() {
            try {
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('vip_status', 'active')
                    .order('vip_purchased_at', { ascending: false });
                
                if (error) throw error;
                
                const tableBody = document.getElementById('vipUsersTable');
                
                if (!users || users.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="no-data">هیچ کاربر VIP فعالی وجود ندارد</td>
                        </tr>
                    `;
                    return;
                }
                
                tableBody.innerHTML = '';
                
                users.forEach(user => {
                    const planName = user.vip_plan === 'gold' ? 'طلایی' : 'الماس';
                    const purchaseDate = user.vip_purchased_at ? 
                        new Date(user.vip_purchased_at).toLocaleDateString('fa-IR') : '-';
                    
                    // محاسبه سقف استخراج
                    let cap = 'نامشخص';
                    if (gameState.vipSettings) {
                        cap = user.vip_plan === 'gold' 
                            ? gameState.vipSettings.gold_plan_cap.toLocaleString() 
                            : gameState.vipSettings.diamond_plan_cap.toLocaleString();
                        cap += ` (${user.current_cycle_mined || 0} استفاده شده)`;
                    }
                    
                    tableBody.innerHTML += `
                        <tr>
                            <td>
                                <div class="user-email">${user.email}</div>
                            </td>
                            <td>
                                <span class="user-plan ${user.vip_plan === 'gold' ? 'plan-gold' : 'plan-diamond'}">
                                    ${planName}
                                </span>
                            </td>
                            <td>
                                <span class="status-badge status-active-badge">فعال</span>
                            </td>
                            <td>${cap}</td>
                            <td class="date-cell">${purchaseDate}</td>
                            <td>
                                <div class="admin-actions">
                                    <button class="action-btn btn-view" onclick="viewUserDetails('${user.id}')">
                                        <i class="fas fa-eye"></i> مشاهده
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
            } catch (error) {
                console.error('خطا در بارگذاری کاربران VIP:', error);
                document.getElementById('vipUsersTable').innerHTML = `
                    <tr>
                        <td colspan="6" class="no-data">خطا در بارگذاری داده‌ها</td>
                    </tr>
                `;
            }
        }

        // بارگذاری پرداخت‌ها
        async function loadPayments() {
            try {
                const { data: payments, error } = await supabase
                    .from('vip_payments')
                    .select(`
                        *,
                        users (
                            email
                        )
                    `)
                    .order('created_at', { ascending: false })
                    .limit(50);
                
                if (error) throw error;
                
                const tableBody = document.getElementById('paymentsTable');
                
                if (!payments || payments.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="no-data">هیچ پرداختی ثبت نشده است</td>
                        </tr>
                    `;
                    return;
                }
                
                tableBody.innerHTML = '';
                
                payments.forEach(payment => {
                    const user = payment.users;
                    const planName = payment.plan_type === 'gold' ? 'طلایی' : 'الماس';
                    const date = new Date(payment.created_at).toLocaleDateString('fa-IR');
                    
                    let statusClass = '';
                    let statusText = '';
                    
                    switch (payment.status) {
                        case 'pending':
                            statusClass = 'status-pending-badge';
                            statusText = 'در انتظار';
                            break;
                        case 'confirmed':
                            statusClass = 'status-confirmed-badge';
                            statusText = 'تایید شده';
                            break;
                        case 'rejected':
                            statusClass = 'status-rejected-badge';
                            statusText = 'رد شده';
                            break;
                        default:
                            statusClass = 'status-inactive-badge';
                            statusText = 'نامشخص';
                    }
                    
                    tableBody.innerHTML += `
                        <tr>
                            <td>
                                <div class="user-email">${user?.email || 'کاربر حذف شده'}</div>
                            </td>
                            <td>
                                <span class="user-plan ${payment.plan_type === 'gold' ? 'plan-gold' : 'plan-diamond'}">
                                    ${planName}
                                </span>
                            </td>
                            <td>${payment.amount} USDT</td>
                            <td class="txid-cell">${payment.txid || '-'}</td>
                            <td>
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </td>
                            <td class="date-cell">${date}</td>
                            <td>${payment.admin_notes || '-'}</td>
                        </tr>
                    `;
                });
                
            } catch (error) {
                console.error('خطا در بارگذاری پرداخت‌ها:', error);
                document.getElementById('paymentsTable').innerHTML = `
                    <tr>
                        <td colspan="7" class="no-data">خطا در بارگذاری داده‌ها</td>
                    </tr>
                `;
            }
        }

        // بارگذاری همه کاربران
        async function loadAllUsers() {
            try {
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(50);
                
                if (error) throw error;
                
                const tableBody = document.getElementById('allUsersTable');
                
                if (!users || users.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="no-data">هیچ کاربری وجود ندارد</td>
                        </tr>
                    `;
                    return;
                }
                
                tableBody.innerHTML = '';
                
                users.forEach(user => {
                    const joinDate = new Date(user.created_at).toLocaleDateString('fa-IR');
                    
                    let vipStatus = '';
                    switch (user.vip_status) {
                        case 'active':
                            vipStatus = '<span class="status-badge status-active-badge">VIP فعال</span>';
                            break;
                        case 'pending':
                            vipStatus = '<span class="status-badge status-pending-badge">در انتظار</span>';
                            break;
                        case 'inactive':
                        default:
                            vipStatus = '<span class="status-badge status-inactive-badge">کاربر عادی</span>';
                    }
                    
                    tableBody.innerHTML += `
                        <tr>
                            <td>
                                <div class="user-email">${user.email}</div>
                                ${user.is_admin ? '<small style="color: var(--admin-color);">👑 ادمین</small>' : ''}
                            </td>
                            <td>${user.balance ? user.balance.toLocaleString() : 0}</td>
                            <td>${user.level || 0}</td>
                            <td>${vipStatus}</td>
                            <td class="date-cell">${joinDate}</td>
                            <td>${user.total_referrals || 0}</td>
                        </tr>
                    `;
                });
                
            } catch (error) {
                console.error('خطا در بارگذاری کاربران:', error);
                document.getElementById('allUsersTable').innerHTML = `
                    <tr>
                        <td colspan="6" class="no-data">خطا در بارگذاری داده‌ها</td>
                    </tr>
                `;
            }
        }

        // تایید درخواست VIP
        async function approveVIPRequest(paymentId, userId) {
            if (!confirm('آیا از تایید این درخواست VIP مطمئن هستید؟')) {
                return;
            }
            
            try {
                // پیدا کردن اطلاعات پرداخت
                const { data: payment, error: paymentError } = await supabase
                    .from('vip_payments')
                    .select('*')
                    .eq('id', paymentId)
                    .single();
                
                if (paymentError) throw paymentError;
                
                // آپدیت وضعیت کاربر
                const { error: userError } = await supabase
                    .from('users')
                    .update({
                        vip_status: 'active',
                        vip_approved_by: currentUser.email,
                        vip_approved_at: new Date().toISOString(),
                        vip_purchased_at: payment.created_at
                    })
                    .eq('id', userId);
                
                if (userError) throw userError;
                
                // آپدیت وضعیت پرداخت
                const { error: updateError } = await supabase
                    .from('vip_payments')
                    .update({
                        status: 'confirmed',
                        admin_notes: `تایید شده توسط ${currentUser.email} در ${new Date().toLocaleString('fa-IR')}`
                    })
                    .eq('id', paymentId);
                
                if (updateError) throw updateError;
                
                // اگر کاربر فعلی همان کاربری است که درخواست داده، آپدیت وضعیت محلی
                if (currentUser.id === userId) {
                    currentUser.vip_status = 'active';
                    currentUser.vip_approved_by = currentUser.email;
                    currentUser.vip_approved_at = new Date().toISOString();
                    updateVIPDisplay();
                }
                
                // بروزرسانی داده‌های ادمین
                await loadAdminData();
                
                showNotification('درخواست تایید شد', 'وضعیت کاربر به VIP فعال تغییر کرد', 'success');
                
            } catch (error) {
                console.error('خطا در تایید درخواست:', error);
                showNotification('خطا', 'خطا در تایید درخواست', 'error');
            }
        }

        // رد درخواست VIP
        async function rejectVIPRequest(paymentId) {
            const reason = prompt('لطفاً دلیل رد درخواست را وارد کنید:');
            if (!reason) {
                showNotification('رد شد', 'رد درخواست لغو شد', 'warning');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('vip_payments')
                    .update({
                        status: 'rejected',
                        admin_notes: `رد شده توسط ${currentUser.email} - دلیل: ${reason}`
                    })
                    .eq('id', paymentId);
                
                if (error) throw error;
                
                // بروزرسانی داده‌های ادمین
                await loadAdminData();
                
                showNotification('درخواست رد شد', 'درخواست VIP با موفقیت رد شد', 'success');
                
            } catch (error) {
                console.error('خطا در رد درخواست:', error);
                showNotification('خطا', 'خطا در رد درخواست', 'error');
            }
        }

        // مشاهده جزئیات کاربر
        async function viewUserDetails(userId) {
            try {
                const { data: user, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', userId)
                    .single();
                
                if (error) throw error;
                
                const details = `
ایمیل: ${user.email}
موجودی طلا: ${user.balance ? user.balance.toLocaleString() : 0}
سطح: ${user.level || 0}
وضعیت VIP: ${user.vip_status || 'کاربر عادی'}
پلن VIP: ${user.vip_plan || 'ندارد'}
تاریخ عضویت: ${new Date(user.created_at).toLocaleDateString('fa-IR')}
تعداد زیرمجموعه: ${user.total_referrals || 0}
کل استخراج: ${user.total_mined_all_time ? user.total_mined_all_time.toLocaleString() : 0}
                `;
                
                alert(details);
                
            } catch (error) {
                console.error('خطا در مشاهده جزئیات:', error);
                showNotification('خطا', 'خطا در مشاهده جزئیات کاربر', 'error');
            }
        }

        // ==================== سیستم زیرمجموعه ====================
        async function loadReferralInfo() {
            if (!currentUser) return;
            
            // نمایش کد معرف
            document.getElementById('myReferralCode').textContent = currentUser.referral_code || '---';
            document.getElementById('myReferralEarnings').textContent = (currentUser.referral_earnings || 0).toLocaleString();
            
            // بارگذاری لیست زیرمجموعه‌ها
            await loadReferralsList();
        }

        async function loadReferralsList() {
            if (!currentUser) return;
            
            try {
                const { data: referrals, error } = await supabase
                    .from('referrals')
                    .select(`
                        *,
                        referred_user:users!referrals_referred_id_fkey (
                            email,
                            created_at
                        )
                    `)
                    .eq('referrer_id', currentUser.id)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const referralsList = document.getElementById('referralsList');
                
                if (!referrals || referrals.length === 0) {
                    referralsList.innerHTML = `
                        <div class="referral-item">
                            <div>
                                <div class="referral-email">هنوز کسی را دعوت نکرده‌اید</div>
                                <div class="referral-date">با کد بالا دوستان خود را دعوت کنید</div>
                            </div>
                            <span class="referral-reward">0 سکه</span>
                        </div>
                    `;
                    return;
                }
                
                referralsList.innerHTML = '';
                
                referrals.forEach(ref => {
                    const user = ref.referred_user;
                    const email = user?.email || 'کاربر دعوت شده';
                    const masked = maskEmail(email);
                    const date = new Date(ref.created_at).toLocaleDateString('fa-IR');
                    
                    referralsList.innerHTML += `
                        <div class="referral-item">
                            <div>
                                <div class="referral-email">${masked}</div>
                                <div class="referral-date">${date} - سطح ${ref.level}</div>
                            </div>
                            <span class="referral-reward">+${ref.amount} سکه</span>
                        </div>
                    `;
                });
                
            } catch (error) {
                console.error('خطا در بارگذاری زیرمجموعه‌ها:', error);
                document.getElementById('referralsList').innerHTML = `
                    <div class="referral-item">
                        <div>
                            <div class="referral-email">خطا در بارگذاری</div>
                            <div class="referral-date">لطفاً دوباره تلاش کنید</div>
                        </div>
                        <span class="referral-reward">-</span>
                    </div>
                `;
            }
        }

        function maskEmail(email) {
            if (!email || !email.includes('@')) return 'کاربر دعوت شده';
            
            const [name, domain] = email.split('@');
            const showPart = name.substring(0, Math.min(3, name.length));
            return showPart + '***@' + domain;
        }

        function copyReferralCode() {
            const code = document.getElementById('myReferralCode').textContent;
            if (code && code !== 'در حال بارگذاری...' && code !== '---') {
                navigator.clipboard.writeText(code).then(() => {
                    showNotification('کپی موفق', 'کد معرف با موفقیت کپی شد!', 'success');
                });
            }
        }

        function shareViaWhatsApp() {
            if (!currentUser) return;
            const code = currentUser.referral_code;
            const message = `سلام! به بازی معدن‌چی طلا بپیوند و ۱۰,۰۰۰ سکه طلای رایگان بگیر! 🎮💰\n\nکد معرف من: ${code}\n\nلینک بازی: ${window.location.origin}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
        }

        function shareViaTelegram() {
            if (!currentUser) return;
            const code = currentUser.referral_code;
            const message = `سلام! به بازی معدن‌چی طلا بپیوند و ۱۰,۰۰۰ سکه طلای رایگان بگیر! 🎮💰\n\nکد معرف من: ${code}\n\nلینک بازی: ${window.location.origin}`;
            window.open(`https://t.me/share/url?url=${encodeURIComponent(window.location.origin)}&text=${encodeURIComponent(message)}`, '_blank');
        }

        function copyInviteLink() {
            if (!currentUser) return;
            const code = currentUser.referral_code;
            const link = `${window.location.origin}?ref=${code}`;
            navigator.clipboard.writeText(link).then(() => {
                showNotification('کپی موفق', 'لینک دعوت با موفقیت کپی شد!', 'success');
            });
        }

        // ==================== سیستم مدیریت تایمرها ====================
        async function saveTimerToDatabase(hammerId, duration) {
            if (!currentUser) return null;
            
            try {
                const startTime = new Date();
                
                await supabase
                    .from('user_timers')
                    .update({ 
                        is_active: false,
                        updated_at: new Date()
                    })
                    .eq('user_id', currentUser.id)
                    .eq('hammer_id', hammerId)
                    .eq('is_active', true);

                const { data, error } = await supabase
                    .from('user_timers')
                    .insert({
                        user_id: currentUser.id,
                        hammer_id: hammerId,
                        start_time: startTime.toISOString(),
                        duration: duration,
                        is_active: true
                    })
                    .select()
                    .single();
                
                if (error) throw error;
                return data;
                
            } catch (error) {
                console.error('Error saving timer:', error);
                return null;
            }
        }

        async function updateTimerInDatabase(hammerId, updates) {
            if (!currentUser) return null;
            
            try {
                const { data, error } = await supabase
                    .from('user_timers')
                    .update({
                        ...updates,
                        updated_at: new Date()
                    })
                    .eq('user_id', currentUser.id)
                    .eq('hammer_id', hammerId)
                    .eq('is_active', true)
                    .select()
                    .single();
                
                if (error) throw error;
                return data;
                
            } catch (error) {
                console.error('Error updating timer:', error);
                return null;
            }
        }

        async function deactivateTimer(hammerId) {
            return await updateTimerInDatabase(hammerId, {
                is_active: false
            });
        }

        async function loadActiveTimers() {
            if (!currentUser) return [];
            
            try {
                const { data: timers, error } = await supabase
                    .from('user_timers')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .eq('is_active', true);
                
                if (error) throw error;
                return timers || [];
                
            } catch (error) {
                console.error('Error loading timers:', error);
                return [];
            }
        }

        function calculateTimeLeft(timer) {
            const startTime = new Date(timer.start_time);
            const now = new Date();
            const elapsedSeconds = Math.floor((now - startTime) / 1000);
            const timeLeft = timer.duration - elapsedSeconds;
            
            return Math.max(0, timeLeft);
        }

        async function restoreTimersState() {
            const activeTimers = await loadActiveTimers();
            
            activeTimers.forEach(timer => {
                const timeLeft = calculateTimeLeft(timer);
                const hammer = gameState.hammers.find(h => h.id === timer.hammer_id);
                
                if (hammer && timeLeft > 0) {
                    hammer.isActive = true;
                    hammer.isOnCooldown = false;
                    hammer.timeLeft = timeLeft;
                    hammer.progress = 1 - (timeLeft / timer.duration);
                } else if (hammer && timeLeft <= 0) {
                    completeMining(timer.hammer_id);
                }
            });
        }

        // ==================== سیستم تبدیل ارز ====================
        function calculateUSDT() {
            const goldAmount = parseInt(document.getElementById('goldAmount').value) || 0;
            const usdtAmount = goldAmount * CONVERSION_RATE;
            document.getElementById('usdtResult').textContent = usdtAmount.toFixed(8) + ' USDT';
        }

        async function convertGoldToUSDT() {
            if (!currentUser) {
                showNotification('ورود نیاز است', 'لطفاً اول وارد حساب کاربری خود شوید', 'warning');
                return;
            }

            const goldAmount = parseInt(document.getElementById('goldAmount').value);

            if (!goldAmount || goldAmount <= 0) {
                showNotification('ورود نامعتبر', 'لطفاً مقدار معتبری وارد کنید', 'error');
                return;
            }

            if (goldAmount > gameState.rockBalance) {
                showNotification('موجودی ناکافی', 'موجودی طلای شما کافی نیست', 'error');
                return;
            }

            try {
                const usdtAmount = goldAmount * CONVERSION_RATE;
                
                const newGoldBalance = gameState.rockBalance - goldAmount;
                const newUSDTBalance = gameState.usdtBalance + usdtAmount;

                const { data: updatedUser, error } = await supabase
                    .from('users')
                    .update({
                        balance: newGoldBalance,
                        usdt_balance: newUSDTBalance,
                        updated_at: new Date()
                    })
                    .eq('id', currentUser.id)
                    .select()
                    .single();

                if (error) throw error;

                const { error: conversionError } = await supabase
                    .from('conversions')
                    .insert({
                        user_id: currentUser.id,
                        gold_amount: goldAmount,
                        usdt_amount: usdtAmount,
                        conversion_rate: CONVERSION_RATE
                    });

                if (conversionError) throw conversionError;

                currentUser = updatedUser;
                gameState.rockBalance = newGoldBalance;
                gameState.usdtBalance = newUSDTBalance;

                updateUI();
                updateProfile();
                loadConversionHistory();

                showNotification('تبدیل موفق', `${goldAmount.toLocaleString()} سکه طلا به ${usdtAmount.toFixed(8)} تتر تبدیل شد`, 'success');

                document.getElementById('goldAmount').value = '';
                document.getElementById('usdtResult').textContent = '0 USDT';

            } catch (error) {
                console.error('Error converting gold to USDT:', error);
                showNotification('خطا در تبدیل', 'لطفاً دوباره تلاش کنید', 'error');
            }
        }

        async function loadConversionHistory() {
            if (!currentUser) return;

            try {
                const { data: conversions, error } = await supabase
                    .from('conversions')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (error) throw error;

                const historyContainer = document.getElementById('conversionHistory');
                historyContainer.innerHTML = '';

                if (!conversions || conversions.length === 0) {
                    historyContainer.innerHTML = '<div class="history-item">هنوز تبدیلی انجام نداده‌اید</div>';
                    return;
                }

                conversions.forEach(conversion => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    
                    const date = new Date(conversion.created_at);
                    const formattedDate = date.toLocaleDateString('fa-IR');
                    
                    historyItem.innerHTML = `
                        <div>
                            <span class="history-amount history-gold">${conversion.gold_amount.toLocaleString()} GOLD</span>
                            <i class="fas fa-arrow-left" style="margin: 0 8px; color: var(--gray);"></i>
                            <span class="history-amount history-usdt">${conversion.usdt_amount.toFixed(8)} USDT</span>
                        </div>
                        <div class="history-date">${formattedDate}</div>
                    `;
                    
                    historyContainer.appendChild(historyItem);
                });

            } catch (error) {
                console.error('Error loading conversion history:', error);
            }
        }

        // ==================== سیستم لودینگ ====================
        function startLoading() {
            let progress = 0;
            const loadingBar = document.getElementById('loadingBar');
            const loadingPercent = document.getElementById('loadingPercent');
            const loadingAssets = document.getElementById('loadingAssets');
            
            const loadingInterval = setInterval(() => {
                progress += Math.random() * 25;
                if (progress > 100) progress = 100;
                
                loadingBar.style.width = `${progress}%`;
                loadingPercent.textContent = `${Math.round(progress)}%`;
                
                const assetsLoaded = Math.min(5, Math.floor(progress / 20));
                loadingAssets.textContent = `${assetsLoaded}/5`;
                
                if (progress === 100) {
                    clearInterval(loadingInterval);
                    setTimeout(() => {
                        document.getElementById('loadingPage').style.display = 'none';
                        showGamePage();
                    }, 600);
                }
            }, 200);
        }

        function showGamePage() {
            document.getElementById('gamePage').style.display = 'block';
            checkAuthState();
            initGame();
        }

        // ==================== سیستم احراز هویت ====================
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const referralCode = document.getElementById('referralCode').value.trim().toUpperCase();
            const button = document.getElementById('registerBtn');
            
            setLoading(button, true);
            
            try {
                console.log('📝 شروع ثبت‌نام جدید');
                console.log('ایمیل:', email);
                console.log('کد معرف وارد شده:', referralCode);
                
                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email: email,
                    password: password
                });
                
                if (authError) throw authError;
                
                console.log('✅ Auth موفق. User ID:', authData.user.id);
                
                const userReferralCode = 'G' + Math.random().toString(36).substring(2, 7).toUpperCase();
                console.log('کد معرف جدید:', userReferralCode);
                
                const userData = {
                    id: authData.user.id,
                    email: email,
                    balance: 10000,
                    referral_code: userReferralCode,
                    referred_by: referralCode || null,
                    level: 0,
                    total_mined: 0,
                    referral_earnings: 0,
                    total_referrals: 0,
                    vip_plan: null,
                    vip_status: 'inactive',
                    current_cycle_mined: 0,
                    total_mined_all_time: 0,
                    is_admin: false,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                console.log('ذخیره کاربر:', userData);
                
                const { data: newUser, error: userError } = await supabase
                    .from('users')
                    .insert(userData)
                    .select()
                    .single();
                    
                if (userError) throw userError;
                
                console.log('✅ کاربر ایجاد شد:', newUser);
                
                if (referralCode) {
                    console.log('🎯 استفاده از تابع قطعی');
                    
                    setTimeout(() => {
                        guaranteedReferral(referralCode, email)
                            .then(() => console.log('پرداخت کامل'))
                            .catch(err => console.error('خطا:', err));
                    }, 2000);
                }
                
                showMessage('✅ ثبت نام موفق!', 'success');
                
                const { data: loginData } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                hideAuthPage();
                showGame(newUser);
                
                // پاک کردن فیلدها
                document.getElementById('registerEmail').value = '';
                document.getElementById('registerPassword').value = '';
                document.getElementById('referralCode').value = '';
                
            } catch (error) {
                console.error('❌ خطا در ثبت‌نام:', error);
                showMessage('خطا در ثبت نام', 'error');
            }
            
            setLoading(button, false);
        });

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const button = document.getElementById('loginBtn');
            
            setLoading(button, true);
            
            try {
                const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (authError) {
                    showMessage('ایمیل یا رمز عبور اشتباه است', 'error');
                    setLoading(button, false);
                    return;
                }
                
                await loadUserProfile(authData.user.id);
                
                // پاک کردن فیلدها
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                
            } catch (error) {
                console.error('Login error:', error);
                showMessage('خطا در ورود. لطفاً دوباره تلاش کنید.', 'error');
            }
            
            setLoading(button, false);
        });

        async function loadUserProfile(userId) {
            try {
                const { data: user, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', userId)
                    .single();
                
                if (error) {
                    const { data: newUser } = await supabase
                        .from('users')
                        .insert([
                            {
                                id: userId,
                                email: (await supabase.auth.getUser()).data.user.email,
                                balance: 10000,
                                referral_code: generateReferralCode(),
                                level: 0,
                                total_mined: 0,
                                referral_earnings: 0,
                                total_referrals: 0,
                                vip_plan: null,
                                vip_status: 'inactive',
                                current_cycle_mined: 0,
                                total_mined_all_time: 0,
                                is_admin: false
                            }
                        ])
                        .select()
                        .single();
                    
                    hideAuthPage();
                    showGame(newUser);
                } else {
                    hideAuthPage();
                    showGame(user);
                }
            } catch (error) {
                console.error('Profile load error:', error);
            }
        }

        async function updateUserBalance(userId, newBalance, newTotalMined, newLevel = null) {
            try {
                const updates = { 
                    balance: newBalance,
                    total_mined: newTotalMined,
                    updated_at: new Date()
                };
                
                if (newLevel !== null) {
                    updates.level = newLevel;
                }
                
                const { data: user, error } = await supabase
                    .from('users')
                    .update(updates)
                    .eq('id', userId)
                    .select()
                    .single();
                
                if (error) throw error;
                return user;
            } catch (error) {
                console.error('Update error:', error);
                return null;
            }
        }

        async function checkAuthState() {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (session) {
                await loadUserProfile(session.user.id);
            } else {
                document.getElementById('guestMessage').style.display = 'block';
            }
        }

        // ==================== توابع اصلی بازی ====================
        async function showGame(user) {
    console.log('🎮 showGame called for:', user.email);
    
    currentUser = user;
    document.getElementById('authPage').style.display = 'none';
    
    document.querySelector('.user-profile-btn').innerHTML = '<i class="fas fa-user-check"></i>';
    document.getElementById('guestMessage').style.display = 'none';
    
    gameState.rockBalance = user.balance || 0;
    gameState.usdtBalance = user.usdt_balance || 0;
    updateUI();
    updateProfile();
    
    // نمایش دکمه ادمین اگر کاربر ادمین باشد
    if (currentUser.is_admin) {
        document.getElementById('adminBtn').style.display = 'block';
    }
    
    // بارگذاری تنظیمات VIP
    await loadVIPSettings();
    
    // بارگذاری وضعیت VIP از دیتابیس
    await checkUserVIPStatus();
    
    await checkActiveResetTimers();
    await restoreTimersState();
    loadConversionHistory();
    loadReferralInfo();
    
    showSection('hammers');
    
    showNotification('خوش آمدید', `${user.email} عزیز به بازی معدن‌چی طلا خوش آمدید!`, 'success');
}

        function hideAuthPage() {
            document.getElementById('authPage').style.display = 'none';
            document.getElementById('registerEmail').value = '';
            document.getElementById('registerPassword').value = '';
            document.getElementById('referralCode').value = '';
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
        }

        function showAuthPage() {
            document.getElementById('authPage').style.display = 'flex';
            showTab('register');
        }

        function updateGame() {
            let activeCount = 0;
            
            gameState.hammers.forEach(hammer => {
                if (hammer.isActive && hammer.timeLeft > 0) {
                    hammer.timeLeft--;
                    activeCount++;
                    
                    hammer.progress = 1 - (hammer.timeLeft / hammer.duration);
                    updateMountainVisual();
                    
                    if (hammer.timeLeft === 0) {
                        completeMining(hammer.id);
                    }
                } else if (hammer.isOnCooldown && hammer.timeLeft > 0) {
                    hammer.timeLeft--;
                    if (hammer.timeLeft === 0) {
                        hammer.isOnCooldown = false;
                    }
                }
            });
            
            gameState.activeTimers = activeCount;
            updateUI();
            renderHammers();
        }

        // ==================== سیستم استخراج ====================
        function renderHammers() {
            const hammersContainer = document.getElementById('hammersContainer');
            hammersContainer.innerHTML = '';
            
            gameState.hammers.forEach(hammer => {
                const hammerCard = document.createElement('div');
                hammerCard.className = 'hammer-card';
                
                if (hammer.isActive) {
                    hammerCard.classList.add('active');
                } else if (hammer.isOnCooldown) {
                    hammerCard.classList.add('cooldown');
                }
                
                let statusText = '';
                let statusClass = '';
                
                if (hammer.isActive) {
                    statusText = 'فعال';
                    statusClass = 'status-active';
                } else if (hammer.isOnCooldown) {
                    statusText = 'در حال بازیابی';
                    statusClass = 'status-cooldown';
                } else {
                    statusText = 'آماده';
                    statusClass = 'status-ready';
                }
                
                let timerText = '';
                if (hammer.isActive) {
                    const formattedTime = formatTime(hammer.timeLeft);
                    timerText = `⏳ ${formattedTime} - ${Math.round(hammer.progress * 100)}%`;
                } else if (hammer.isOnCooldown) {
                    timerText = `❄️ ${hammer.timeLeft} ثانیه`;
                } else {
                    timerText = '✅ آماده';
                }
                
                const isDisabled = !currentUser || hammer.isActive || hammer.isOnCooldown;
                const buttonText = !currentUser ? 'ورود برای شروع' : (hammer.isActive || hammer.isOnCooldown) ? 'در حال فعالیت' : 'شروع استخراج';
                
                hammerCard.innerHTML = `
                    <div class="hammer-header">
                        <div class="hammer-name">${hammer.name}</div>
                        <div class="hammer-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="hammer-icon">
                        <i class="${hammer.icon}"></i>
                    </div>
                    <div class="hammer-stats">
                        <div>پاداش: <span class="hammer-power">${Math.round(hammer.reward * getRewardMultiplier())} GOLD</span></div>
                        <div>مدت: ${formatTime(hammer.duration)}</div>
                    </div>
                    <div class="hammer-timer">
                        ${timerText}
                    </div>
                    <div class="hammer-actions">
                        <button class="btn btn-gold" onclick="activateHammer(${hammer.id})" 
                            ${isDisabled ? 'disabled' : ''}>
                            ${buttonText}
                        </button>
                    </div>
                `;
                
                hammersContainer.appendChild(hammerCard);
            });
        }

        async function activateHammer(hammerId) {
            console.log('Activating hammer:', hammerId);
            
            if (!currentUser) {
                showAuthPage();
                return;
            }
            
            // چک کردن محدودیت قبل از فعال کردن چکش
            const canMine = await checkUserLimit();
            if (!canMine) {
                return;
            }
            
            const hammer = gameState.hammers.find(h => h.id === hammerId);
            
            if (!hammer.isActive && !hammer.isOnCooldown) {
                try {
                    const timer = await saveTimerToDatabase(hammerId, hammer.duration);
                    
                    if (timer) {
                        hammer.isActive = true;
                        hammer.timeLeft = hammer.duration;
                        hammer.progress = 0;
                        
                        renderHammers();
                        updateUI();
                        updateMountainVisual();
                        
                        showNotification('استخراج شروع شد', 'چکش طلایی شروع به کار کرد!', 'info');
                    }
                    
                } catch (error) {
                    console.error('Error activating hammer:', error);
                }
            }
        }

        // ==================== سیستم سطح‌بندی ====================
        const levels = [
            {
                id: 0,
                name: 'معدن‌چی تازه‌کار',
                icon: 'fas fa-gem',
                price: 0,
                rewardMultiplier: 1.0,
                description: 'شروع سفر طلایی'
            },
            {
                id: 1,
                name: 'معدن‌چی حرفه‌ای',
                icon: 'fas fa-crown',
                price: 10000,
                rewardMultiplier: 1.2,
                description: '۲۰٪ افزایش پاداش'
            },
            {
                id: 2,
                name: 'استاد معدن‌چی',
                icon: 'fas fa-shield-alt',
                price: 25000,
                rewardMultiplier: 1.3,
                description: '۳۰٪ افزایش پاداش'
            },
            {
                id: 3,
                name: 'سلطان طلا',
                icon: 'fas fa-gem',
                price: 50000,
                rewardMultiplier: 1.5,
                description: '۵۰٪ افزایش پاداش'
            },
            {
                id: 4,
                name: 'افسانه معدن',
                icon: 'fas fa-dragon',
                price: 100000,
                rewardMultiplier: 1.75,
                description: '۷۵٪ افزایش پاداش'
            },
            {
                id: 5,
                name: 'اسطوره طلا',
                icon: 'fas fa-trophy',
                price: 250000,
                rewardMultiplier: 2.2,
                description: '۱۲۰٪ افزایش پاداش'
            }
        ];

        function showLevelsSection() {
            hideAllSections();
            document.getElementById('levelsSection').style.display = 'block';
            updateLevelsDisplay();
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.querySelector('i').classList.contains('fa-chart-line')) {
                    item.classList.add('active');
                }
            });
        }

        function updateLevelsDisplay() {
            if (!currentUser) return;
            
            const currentLevel = currentUser.level || 0;
            document.getElementById('currentLevelDisplay').textContent = currentLevel;
            document.getElementById('profileLevel').textContent = currentLevel;
            
            updateLevelProgress();
            renderLevelCards();
        }

        function updateLevelProgress() {
            const currentLevel = currentUser.level || 0;
            const currentBalance = gameState.rockBalance;
            
            if (currentLevel < levels.length - 1) {
                const nextLevel = levels[currentLevel + 1];
                const progress = Math.min((currentBalance / nextLevel.price) * 100, 100);
                
                document.getElementById('levelProgressFill').style.width = `${progress}%`;
                document.getElementById('levelProgressText').textContent = 
                    `${currentBalance.toLocaleString()}/${nextLevel.price.toLocaleString()} طلا`;
            } else {
                document.getElementById('levelProgressFill').style.width = '100%';
                document.getElementById('levelProgressText').textContent = 'حداکثر سطح!';
            }
        }

        function renderLevelCards() {
            const levelsGrid = document.getElementById('levelsGrid');
            levelsGrid.innerHTML = '';
            
            const currentLevel = currentUser.level || 0;
            const currentBalance = gameState.rockBalance;
            
            levels.forEach(level => {
                const levelCard = document.createElement('div');
                levelCard.className = 'level-card';
                
                let status = 'locked';
                let badgeText = 'قفل شده';
                
                if (level.id === currentLevel) {
                    status = 'current';
                    badgeText = 'فعلی';
                } else if (level.id < currentLevel) {
                    status = 'unlocked';
                    badgeText = 'خریداری شده';
                } else if (level.id === currentLevel + 1 && currentBalance >= level.price) {
                    status = 'unlocked';
                    badgeText = 'قابل خرید';
                }
                
                levelCard.classList.add(status);
                
                const canPurchase = level.id === currentLevel + 1 && currentBalance >= level.price;
                
                levelCard.innerHTML = `
                    <div class="level-header">
                        <div class="level-name">${level.name}</div>
                        <div class="level-badge badge-${status}">${badgeText}</div>
                    </div>
                    
                    <div class="level-icon">
                        <i class="${level.icon}"></i>
                    </div>
                    
                    <div class="level-stats">
                        <div class="level-stat">
                            <span class="stat-label">افزایش پاداش:</span>
                            <span class="stat-value">+${((level.rewardMultiplier - 1) * 100).toFixed(0)}٪</span>
                        </div>
                        <div class="level-stat">
                            <span class="stat-label">ضریب درآمد:</span>
                            <span class="stat-value">${level.rewardMultiplier}x</span>
                        </div>
                        <div class="level-stat">
                            <span class="stat-label">سطح:</span>
                            <span class="stat-value">${level.id}</span>
                        </div>
                    </div>
                    
                    ${level.id > currentLevel ? `
                        <div class="level-price">
                            ${level.price.toLocaleString()} طلا
                        </div>
                    ` : ''}
                    
                    <div class="level-actions">
                        ${level.id === currentLevel ? `
                            <button class="level-btn secondary" disabled>
                                <i class="fas fa-check"></i> سطح فعال
                            </button>
                        ` : level.id < currentLevel ? `
                            <button class="level-btn secondary" disabled>
                                <i class="fas fa-unlock"></i> خریداری شده
                            </button>
                        ` : `
                            <button class="level-btn primary" 
                                    onclick="purchaseLevel(${level.id})" 
                                    ${canPurchase ? '' : 'disabled'}>
                                ${canPurchase ? 
                                    '<i class="fas fa-arrow-up"></i> ارتقا سطح' : 
                                    'بودجه ناکافی'
                                }
                            </button>
                        `}
                    </div>
                `;
                
                levelsGrid.appendChild(levelCard);
            });
        }

        async function purchaseLevel(levelId) {
            if (!currentUser) {
                showAuthPage();
                return;
            }
            
            const level = levels.find(l => l.id === levelId);
            const currentBalance = gameState.rockBalance;
            
            if (currentBalance < level.price) {
                showNotification('بودجه ناکافی', 'موجودی طلای شما کافی نیست!', 'error');
                return;
            }
            
            if (levelId !== (currentUser.level || 0) + 1) {
                showNotification('خطای ترتیب', 'شما باید سطح‌ها را به ترتیب خریداری کنید!', 'warning');
                return;
            }
            
            try {
                const newBalance = currentBalance - level.price;
                const newLevel = levelId;
                
                const updatedUser = await updateUserBalance(currentUser.id, newBalance, currentUser.total_mined || 0, newLevel);
                
                if (updatedUser) {
                    currentUser = updatedUser;
                    gameState.rockBalance = newBalance;
                    
                    showLevelUpEffect();
                    
                    updateUI();
                    updateLevelsDisplay();
                    updateProfile();
                    
                    setTimeout(() => {
                        showNotification('ارتقای سطح موفق', `تبریک! شما به سطح ${level.name} ارتقا یافتید!\nپاداش استخراج شما ${level.rewardMultiplier}x شد!`, 'success', 6000);
                    }, 1000);
                }
                
            } catch (error) {
                console.error('Error purchasing level:', error);
                showNotification('خطا در خرید', 'خطا در خرید سطح!', 'error');
            }
        }

        function showLevelUpEffect() {
            const levelsGrid = document.getElementById('levelsGrid');
            const effect = document.createElement('div');
            effect.className = 'level-up-effect';
            levelsGrid.appendChild(effect);
            
            setTimeout(() => {
                effect.remove();
            }, 1000);
        }

        function getRewardMultiplier() {
            const currentLevel = currentUser?.level || 0;
            const level = levels.find(l => l.id === currentLevel);
            return level ? level.rewardMultiplier : 1;
        }

        // ==================== سیستم تأیید چندمرحله‌ای ====================
        function startVerification(reward) {
            gameState.pendingReward = reward;
            gameState.verificationTime = 8;
            gameState.currentStep = 0;
            
            document.getElementById('verificationReward').textContent = `+${reward} GOLD`;
            document.getElementById('verificationTimer').textContent = gameState.verificationTime;
            document.getElementById('verificationBtn').disabled = true;
            document.getElementById('verificationBtn').textContent = 'در حال تأیید...';
            
            resetSteps();
            updateHashDisplay();
            
            if (gameState.hashInterval) clearInterval(gameState.hashInterval);
            gameState.hashInterval = setInterval(updateHashDisplay, 1500);
            
            document.getElementById('confirmationGrid').style.display = 'flex';
            
            if (gameState.verificationInterval) clearInterval(gameState.verificationInterval);
            gameState.verificationInterval = setInterval(updateVerification, 1000);
        }

        function updateVerification() {
            gameState.verificationTime = Math.max(0, gameState.verificationTime - 1);
            
            document.getElementById('verificationTimer').textContent = gameState.verificationTime;
            
            if (gameState.verificationTime === 6) {
                activateStep(1);
            } else if (gameState.verificationTime === 3) {
                activateStep(2);
            } else if (gameState.verificationTime === 0) {
                clearInterval(gameState.verificationInterval);
                clearInterval(gameState.hashInterval);
                
                activateStep(3);
                
                document.getElementById('verificationBtn').disabled = false;
                document.getElementById('verificationBtn').textContent = 'برداشت موفق! 🎉';
                
                setTimeout(() => {
                    if (document.getElementById('confirmationGrid').style.display !== 'none') {
                        document.getElementById('confirmationGrid').style.display = 'none';
                    }
                }, 2000);
            }
        }

        function activateStep(stepNumber) {
            gameState.currentStep = stepNumber;
            resetSteps();
            
            for (let i = 1; i <= stepNumber; i++) {
                const stepCircle = document.querySelector(`#step${i} .step-circle`);
                const step = document.getElementById(`step${i}`);
                
                if (i === stepNumber) {
                    stepCircle.classList.add('active');
                    step.classList.add('active');
                } else {
                    stepCircle.classList.add('completed');
                    stepCircle.innerHTML = '<i class="fas fa-check"></i>';
                }
            }
        }

        function resetSteps() {
            const steps = ['step1', 'step2', 'step3'];
            steps.forEach(stepId => {
                const step = document.getElementById(stepId);
                const circle = step.querySelector('.step-circle');
                circle.className = 'step-circle';
                step.classList.remove('active');
                
                if (stepId === 'step1') {
                    circle.innerHTML = '<i class="fas fa-lock"></i>';
                } else if (stepId === 'step2') {
                    circle.innerHTML = '<i class="fas fa-network-wired"></i>';
                } else if (stepId === 'step3') {
                    circle.innerHTML = '<i class="fas fa-check-double"></i>';
                }
            });
        }

        function completeVerification() {
            clearInterval(gameState.verificationInterval);
            clearInterval(gameState.hashInterval);
            
            document.getElementById('verificationBtn').disabled = false;
            document.getElementById('verificationBtn').textContent = 'برداشت موفق! 🎉';
            
            setTimeout(() => {
                document.getElementById('confirmationGrid').style.display = 'none';
                
                gameState.verificationTime = 8;
                gameState.currentStep = 0;
                document.getElementById('verificationBtn').disabled = true;
                document.getElementById('verificationBtn').textContent = 'در حال تأیید...';
            }, 1500);
        }

        // ==================== توابع کمکی ====================
        function updateUI() {
            document.getElementById('rockBalance').textContent = gameState.rockBalance.toLocaleString();
            document.getElementById('usdtBalance').textContent = gameState.usdtBalance.toLocaleString();
            document.getElementById('activeTimers').textContent = gameState.activeTimers;
        }

        function updateProfile() {
            if (currentUser) {
                document.getElementById('profileEmail').textContent = currentUser.email;
                document.getElementById('profileBalance').textContent = currentUser.balance.toLocaleString();
                document.getElementById('profileUSDT').textContent = (currentUser.usdt_balance || 0).toLocaleString();
                document.getElementById('profileLevel').textContent = currentUser.level;
                document.getElementById('profileMined').textContent = (currentUser.total_mined_all_time || 0).toLocaleString();
            }
        }

        function updateMountainVisual() {
            const activeHammer = gameState.hammers.find(h => h.isActive);
            if (activeHammer) {
                document.getElementById('mountainGold').style.transform = 
                    `perspective(1000px) rotateX(10deg) scaleY(${activeHammer.progress})`;
            } else {
                document.getElementById('mountainGold').style.transform = 
                    'perspective(1000px) rotateX(10deg) scaleY(0)';
            }
        }

        function createGoldParticles() {
            const goldParticlesEl = document.getElementById('goldParticles');
            goldParticlesEl.innerHTML = '';
            const particleCount = 40;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'gold-particle';
                
                const size = Math.random() * 5 + 2;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                
                particle.style.left = `${Math.random() * 85 + 7.5}%`;
                particle.style.top = `${Math.random() * 75 + 15}%`;
                
                particle.style.animationDelay = `${Math.random() * 3}s`;
                particle.style.animationDuration = `${Math.random() * 2 + 3}s`;
                
                goldParticlesEl.appendChild(particle);
            }
        }

        function showSection(section) {
            hideAllSections();
            
            // بستن مودال محدودیت
            document.getElementById('limitModal').style.display = 'none';
            
            if (section === 'vip') {
                document.getElementById('vipSection').style.display = 'block';
                updateVIPDisplay();
                
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.querySelector('i').classList.contains('fa-crown')) {
                        item.classList.add('active');
                    }
                });
            } else if (section === 'profile') {
                if (!currentUser) {
                    showAuthPage();
                    return;
                }
                document.getElementById('profileSection').style.display = 'block';
                updateProfile();
                updateVIPDisplay();
                
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.querySelector('i').classList.contains('fa-user')) {
                        item.classList.add('active');
                    }
                });
            } else if (section === 'conversion') {
                if (!currentUser) {
                    showAuthPage();
                    return;
                }
                document.getElementById('conversionSection').style.display = 'block';
                loadConversionHistory();
                
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.querySelector('i').classList.contains('fa-exchange-alt')) {
                        item.classList.add('active');
                    }
                });
            } else if (section === 'hammers') {
                document.getElementById('mountainSection').style.display = 'block';
                document.getElementById('hammersSection').style.display = 'block';
                
                if (!currentUser) {
                    document.getElementById('guestMessage').style.display = 'block';
                } else {
                    document.getElementById('guestMessage').style.display = 'none';
                }
                
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.querySelector('i').classList.contains('fa-hammer')) {
                        item.classList.add('active');
                    }
                });
            } else if (section === 'levels') {
                if (!currentUser) {
                    showAuthPage();
                    return;
                }
                document.getElementById('levelsSection').style.display = 'block';
                updateLevelsDisplay();
                
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.querySelector('i').classList.contains('fa-chart-line')) {
                        item.classList.add('active');
                    }
                });
            } else if (section === 'referral') {
                if (!currentUser) {
                    showAuthPage();
                    return;
                }
                document.getElementById('referralSection').style.display = 'block';
                loadReferralInfo();
                
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.querySelector('i').classList.contains('fa-user-friends')) {
                        item.classList.add('active');
                    }
                });
            }
        }

        function hideAllSections() {
            document.getElementById('vipSection').style.display = 'none';
            document.getElementById('profileSection').style.display = 'none';
            document.getElementById('conversionSection').style.display = 'none';
            document.getElementById('mountainSection').style.display = 'none';
            document.getElementById('hammersSection').style.display = 'none';
            document.getElementById('levelsSection').style.display = 'none';
            document.getElementById('referralSection').style.display = 'none';
            document.getElementById('vipPaymentContainer').style.display = 'none';
            document.getElementById('vipPlansGrid').style.display = 'grid';
        }

        async function completeMining(hammerId) {
            const hammer = gameState.hammers.find(h => h.id === hammerId);
            if (!hammer || !currentUser) return;
            
            // چک کردن محدودیت کاربر
            const canMine = await checkUserLimit();
            if (!canMine) {
                hammer.isActive = false;
                hammer.isOnCooldown = false;
                renderHammers();
                return;
            }
            
            try {
                const multiplier = getRewardMultiplier();
                const baseReward = hammer.reward;
                const actualReward = Math.round(baseReward * multiplier);
                
                // محاسبه مقادیر جدید
                const newBalance = gameState.rockBalance + actualReward;
                const newTotalMined = (currentUser.total_mined_all_time || 0) + actualReward;
                const newCycleMined = (currentUser.current_cycle_mined || 0) + actualReward;
                
                // آپدیت کاربر در دیتابیس
                const updates = {
                    balance: newBalance,
                    total_mined_all_time: newTotalMined,
                    updated_at: new Date().toISOString()
                };
                
                // اگر کاربر VIP است، current_cycle_mined را هم آپدیت کن
                if (currentUser.vip_status === 'active') {
                    updates.current_cycle_mined = newCycleMined;
                }
                
                const { data: updatedUser, error } = await supabase
                    .from('users')
                    .update(updates)
                    .eq('id', currentUser.id)
                    .select()
                    .single();
                
                if (error) throw error;
                
                // آپدیت وضعیت محلی
                currentUser = updatedUser;
                gameState.rockBalance = newBalance;
                
                // غیرفعال کردن تایمر
                await deactivateTimer(hammerId);
                
                // آپدیت وضعیت چکش
                hammer.isActive = false;
                hammer.isOnCooldown = true;
                hammer.timeLeft = hammer.cooldown;
                hammer.progress = 0;
                
                // آپدیت UI
                updateUI();
                updateProfile();
                updateLevelsDisplay();
                updateVIPProgress();
                
                // نمایش نوتیفیکیشن
                showNotification('استخراج موفق', `${actualReward.toLocaleString()} سکه طلا استخراج شد!`, 'success');
                startVerification(actualReward);
                
            } catch (error) {
                console.error('Error completing mining:', error);
            }
        }

        async function logout() {
    await supabase.auth.signOut();
    window.location.reload();
    currentUser = null;
    document.querySelector('.user-profile-btn').innerHTML = '<i class="fas fa-user"></i>';
    document.getElementById('guestMessage').style.display = 'block';
    document.getElementById('adminBtn').style.display = 'none';
    
    // توقف تایمرها
    if (vipTimerInterval) {
        clearInterval(vipTimerInterval);
        vipTimerInterval = null;
    }
    
    if (userResetTimerInterval) {  // <-- این خط جدید
        clearInterval(userResetTimerInterval);
        userResetTimerInterval = null;
    }
    
    // ریست متغیرها
    isUserResetTimerActive = false;  // <-- این خط جدید
    userResetTimeLeft = 0;           // <-- این خط جدید
    
    showSection('hammers');
    showNotification('خروج موفق', 'از حساب کاربری خود خارج شدید', 'info');
}

        async function initGame() {
            await loadHammersFromDatabase();
            await loadVIPSettings();
            
            updateUI();
            renderHammers();
            createGoldParticles();
            
            document.getElementById('goldAmount').addEventListener('input', calculateUSDT);
            
            setInterval(updateGame, 1000);
            
            // شروع تایمر بررسی سیکل VIP
            setInterval(checkAndResetVIPCycle, 30000);
        }

        async function loadHammersFromDatabase() {
            try {
                const { data: hammers, error } = await supabase
                    .from('hammers')
                    .select('*')
                    .eq('is_active', true)
                    .order('id', { ascending: true });
                
                if (error) {
                    console.error('خطا در لود چکش‌ها:', error);
                    return;
                }
                
                if (hammers && hammers.length > 0) {
                    gameState.hammers = hammers.map(hammer => ({
                        id: hammer.id,
                        name: hammer.name,
                        icon: hammer.icon,
                        duration: hammer.duration,
                        cooldown: hammer.cooldown,
                        reward: hammer.reward,
                        isActive: false,
                        isOnCooldown: false,
                        timeLeft: 0,
                        progress: 0
                    }));
                    console.log('چکش‌ها از دیتابیس لود شد');
                }
            } catch (error) {
                console.error('خطا در لود چکش‌ها از دیتابیس:', error);
            }
        }

        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            let result = '';
            if (hours > 0) {
                result += `${hours} ساعت `;
            }
            if (minutes > 0) {
                result += `${minutes} دقیقه `;
            }
            if (secs > 0 || (hours === 0 && minutes === 0)) {
                result += `${secs} ثانیه`;
            }
            
            return result.trim();
        }

        const hashMessages = [
            "0x1a2b3c4d5e6f7890abcdef1234567890",
            "SHA256: 7d8e9f0a1b2c3d4e5f6a7b8c9d0e1f2",
            "Block #1847291 | TX: 9f8e7d6c5b4a3f2e1d",
            "Nonce: 4294967295 | Hash: 3e4d5c6b7a8998b7",
            "Merkle Root: 2b3c4d5e6f7a8b9c0d1e2f3a",
            "0xdeadbeefcafebabe1234567890abcdef",
            "Timestamp: 1672531200 | PrevHash: 1c2d3e4f",
            "Difficulty: 17.5K | Gas: 21000"
        ];

        function updateHashDisplay() {
            const randomIndex = Math.floor(Math.random() * hashMessages.length);
            document.getElementById('hashDisplay').textContent = hashMessages[randomIndex];
        }

        function setLoading(button, isLoading) {
            button.disabled = isLoading;
            button.innerHTML = isLoading ? 
                '<span class="loading"></span>در حال پردازش...' : 
                button.id === 'registerBtn' ? 'ثبت نام و شروع بازی' : 'ورود به بازی';
        }

        function showMessage(message, type) {
            const messageEl = document.getElementById('authMessage');
            messageEl.textContent = message;
            messageEl.className = 'auth-message';
            messageEl.classList.add(`message-${type}`);
        }

        function showTab(tabName) {
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.auth-form').forEach(form => {
                form.classList.remove('active');
            });
            
            if (tabName === 'register') {
                document.querySelector('.auth-tab:nth-child(1)').classList.add('active');
                document.getElementById('registerForm').classList.add('active');
            } else {
                document.querySelector('.auth-tab:nth-child(2)').classList.add('active');
                document.getElementById('loginForm').classList.add('active');
            }
        }

        function togglePassword(inputId, button) {
            const input = document.getElementById(inputId);
            const icon = button.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        function generateReferralCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = 'G';
            for (let i = 0; i < 5; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        // ==================== توابع سیستم ارجاع ====================
        
        // تولید کد معرف یکتا
        function generateReferralCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = 'G';
            for (let i = 0; i < 5; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        // 🔥 تابع قطعی با RPC
async function guaranteedReferral(referrerCode, referredEmail) {
    console.log('⚔️ guaranteedReferral شروع');
    
    try {
        const { data, error } = await supabase.rpc('add_referral', {
            p_referrer_code: referrerCode,
            p_referred_email: referredEmail
        });
        
        if (error) {
            console.error('❌ RPC error:', error);
            return;
        }
        
        console.log('✅ نتیجه:', data);
        
        if (data && data.error) {
            console.error('خطا از سرور:', data.error);
        } else if (data && data.success) {
            console.log('🎉 ارجاع ثبت شد! ID:', data.referral_id);
            alert(`ارجاع ثبت شد! ${data.amount} سکه به ${data.referrer_email} پرداخت شد.`);
        }
        
    } catch (err) {
        console.error('💥 خطای جدی:', err);
    }
}

        // پرداخت پاداش‌های ارجاع
        async function handleReferralRewards(newUserId, referralCode) {
    try {
        console.log('پرداخت پاداش‌های ارجاع شروع شد');
        console.log('کد معرف:', referralCode);
        
        // ۱. پیدا کردن معرف اصلی
        const { data: referrer, error: refError } = await supabase
            .from('users')
            .select('id, balance, referral_earnings, total_referrals, referred_by')
            .eq('referral_code', referralCode)
            .single();
            
        if (refError || !referrer) {
            console.log('کد معرف معتبر نیست');
            return;
        }
        
        console.log('معرف اصلی پیدا شد:', referrer.id);
        
        // ۲. پرداخت ۵,۰۰۰ سکه به معرف اصلی
        const newBalance = (referrer.balance || 0) + 5000;
        const newReferralEarnings = (referrer.referral_earnings || 0) + 5000;
        const newTotalReferrals = (referrer.total_referrals || 0) + 1;
        
        const { error: updateError } = await supabase
            .from('users')
            .update({
                balance: newBalance,
                referral_earnings: newReferralEarnings,
                total_referrals: newTotalReferrals,
                updated_at: new Date()
            })
            .eq('id', referrer.id);
        
        if (updateError) {
            console.error('خطا در آپدیت معرف:', updateError);
            return;
        }
        
        console.log('۵,۰۰۰ سکه به معرف اصلی پرداخت شد');
        
        // ۳. ثبت در جدول referrals (سطح ۱)
        const { error: insertError } = await supabase
            .from('referrals')
            .insert({
                referrer_id: referrer.id,
                referred_id: newUserId,
                level: 1,
                amount: 5000
            });
        
        if (insertError) {
            console.error('خطا در ثبت ارجاع:', insertError);
        } else {
            console.log('در جدول referrals ثبت شد (سطح ۱)');
        }
        
        // ۴. اگر معرف اصلی خودش با کد دیگری ثبت‌نام کرده
        if (referrer.referred_by) {
            console.log('جستجوی معرف سطح ۲...');
            
            const { data: level2Referrer } = await supabase
                .from('users')
                .select('id, balance, referral_earnings')
                .eq('referral_code', referrer.referred_by)
                .single();
                
            if (level2Referrer) {
                console.log('معرف سطح ۲ پیدا شد:', level2Referrer.id);
                
                // پرداخت ۲,۵۰۰ سکه به معرف سطح ۲
                const level2NewBalance = (level2Referrer.balance || 0) + 2500;
                const level2NewEarnings = (level2Referrer.referral_earnings || 0) + 2500;
                
                const { error: level2UpdateError } = await supabase
                    .from('users')
                    .update({
                        balance: level2NewBalance,
                        referral_earnings: level2NewEarnings,
                        updated_at: new Date()
                    })
                    .eq('id', level2Referrer.id);
                
                if (level2UpdateError) {
                    console.error('خطا در آپدیت معرف سطح ۲:', level2UpdateError);
                } else {
                    console.log('۲,۵۰۰ سکه به معرف سطح ۲ پرداخت شد');
                }
                
                // ثبت در جدول referrals (سطح ۲)
                await supabase
                    .from('referrals')
                    .insert({
                        referrer_id: level2Referrer.id,
                        referred_id: newUserId,
                        level: 2,
                        amount: 2500
                    });
                
                console.log('در جدول referrals ثبت شد (سطح ۲)');
            }
        }
        
        console.log('پرداخت پاداش‌های ارجاع با موفقیت انجام شد');
        
    } catch (error) {
        console.error('خطا در پرداخت پاداش‌های ارجاع:', error);
    }
}

        // ==================== شروع اولیه ====================
        window.addEventListener('load', () => {
            showTab('register');
            startLoading();
            
            const urlParams = new URLSearchParams(window.location.search);
            const refCode = urlParams.get('ref');
            
            if (refCode) {
                document.getElementById('referralCode').value = refCode;
            }
        });
    </script>
</body>
    </html>
